<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<unit xmlns="http://www.srcML.org/srcML/src" revision="0.9.5" language="Java" filename="BrokerService.java">
    <comment type="block">/*
       Copyright 2020-2021 IBM Corp All Rights Reserved

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
 */</comment>

    <package>
        package
        <name>
            <name>com</name>
            <operator>.</operator>
            <name>ibm</name>
            <operator>.</operator>
            <name>hybrid</name>
            <operator>.</operator>
            <name>cloud</name>
            <operator>.</operator>
            <name>sample</name>
            <operator>.</operator>
            <name>stocktrader</name>
            <operator>.</operator>
            <name>broker</name>
        </name>
        ;
    </package>

    <import>
        import
        <name>
            <name>com</name>
            <operator>.</operator>
            <name>ibm</name>
            <operator>.</operator>
            <name>hybrid</name>
            <operator>.</operator>
            <name>cloud</name>
            <operator>.</operator>
            <name>sample</name>
            <operator>.</operator>
            <name>stocktrader</name>
            <operator>.</operator>
            <name>broker</name>
            <operator>.</operator>
            <name>client</name>
            <operator>.</operator>
            <name>AccountClient</name>
        </name>
        ;
    </import>
    <import>
        import
        <name>
            <name>com</name>
            <operator>.</operator>
            <name>ibm</name>
            <operator>.</operator>
            <name>hybrid</name>
            <operator>.</operator>
            <name>cloud</name>
            <operator>.</operator>
            <name>sample</name>
            <operator>.</operator>
            <name>stocktrader</name>
            <operator>.</operator>
            <name>broker</name>
            <operator>.</operator>
            <name>client</name>
            <operator>.</operator>
            <name>PortfolioClient</name>
        </name>
        ;
    </import>
    <import>
        import
        <name>
            <name>com</name>
            <operator>.</operator>
            <name>ibm</name>
            <operator>.</operator>
            <name>hybrid</name>
            <operator>.</operator>
            <name>cloud</name>
            <operator>.</operator>
            <name>sample</name>
            <operator>.</operator>
            <name>stocktrader</name>
            <operator>.</operator>
            <name>broker</name>
            <operator>.</operator>
            <name>client</name>
            <operator>.</operator>
            <name>TradeHistoryClient</name>
        </name>
        ;
    </import>
    <import>
        import
        <name>
            <name>com</name>
            <operator>.</operator>
            <name>ibm</name>
            <operator>.</operator>
            <name>hybrid</name>
            <operator>.</operator>
            <name>cloud</name>
            <operator>.</operator>
            <name>sample</name>
            <operator>.</operator>
            <name>stocktrader</name>
            <operator>.</operator>
            <name>broker</name>
            <operator>.</operator>
            <name>json</name>
            <operator>.</operator>
            <name>Account</name>
        </name>
        ;
    </import>
    <import>
        import
        <name>
            <name>com</name>
            <operator>.</operator>
            <name>ibm</name>
            <operator>.</operator>
            <name>hybrid</name>
            <operator>.</operator>
            <name>cloud</name>
            <operator>.</operator>
            <name>sample</name>
            <operator>.</operator>
            <name>stocktrader</name>
            <operator>.</operator>
            <name>broker</name>
            <operator>.</operator>
            <name>json</name>
            <operator>.</operator>
            <name>Broker</name>
        </name>
        ;
    </import>
    <import>
        import
        <name>
            <name>com</name>
            <operator>.</operator>
            <name>ibm</name>
            <operator>.</operator>
            <name>hybrid</name>
            <operator>.</operator>
            <name>cloud</name>
            <operator>.</operator>
            <name>sample</name>
            <operator>.</operator>
            <name>stocktrader</name>
            <operator>.</operator>
            <name>broker</name>
            <operator>.</operator>
            <name>json</name>
            <operator>.</operator>
            <name>Feedback</name>
        </name>
        ;
    </import>
    <import>
        import
        <name>
            <name>com</name>
            <operator>.</operator>
            <name>ibm</name>
            <operator>.</operator>
            <name>hybrid</name>
            <operator>.</operator>
            <name>cloud</name>
            <operator>.</operator>
            <name>sample</name>
            <operator>.</operator>
            <name>stocktrader</name>
            <operator>.</operator>
            <name>broker</name>
            <operator>.</operator>
            <name>json</name>
            <operator>.</operator>
            <name>Portfolio</name>
        </name>
        ;
    </import>
    <import>
        import
        <name>
            <name>com</name>
            <operator>.</operator>
            <name>ibm</name>
            <operator>.</operator>
            <name>hybrid</name>
            <operator>.</operator>
            <name>cloud</name>
            <operator>.</operator>
            <name>sample</name>
            <operator>.</operator>
            <name>stocktrader</name>
            <operator>.</operator>
            <name>broker</name>
            <operator>.</operator>
            <name>json</name>
            <operator>.</operator>
            <name>WatsonInput</name>
        </name>
        ;
    </import>


    <import>
        import
        <name>
            <name>java</name>
            <operator>.</operator>
            <name>io</name>
            <operator>.</operator>
            <name>PrintWriter</name>
        </name>
        ;
    </import>
    <import>
        import
        <name>
            <name>java</name>
            <operator>.</operator>
            <name>io</name>
            <operator>.</operator>
            <name>StringWriter</name>
        </name>
        ;
    </import>

    <comment type="line">//Logging (JSR 47)</comment>
    <import>
        import
        <name>
            <name>java</name>
            <operator>.</operator>
            <name>util</name>
            <operator>.</operator>
            <name>logging</name>
            <operator>.</operator>
            <name>Level</name>
        </name>
        ;
    </import>
    <import>
        import
        <name>
            <name>java</name>
            <operator>.</operator>
            <name>util</name>
            <operator>.</operator>
            <name>logging</name>
            <operator>.</operator>
            <name>Logger</name>
        </name>
        ;
    </import>

    <comment type="line">//CDI 2.0</comment>
    <import>
        import
        <name>
            <name>javax</name>
            <operator>.</operator>
            <name>inject</name>
            <operator>.</operator>
            <name>Inject</name>
        </name>
        ;
    </import>
    <import>
        import
        <name>
            <name>javax</name>
            <operator>.</operator>
            <name>enterprise</name>
            <operator>.</operator>
            <name>context</name>
            <operator>.</operator>
            <name>RequestScoped</name>
        </name>
        ;
    </import>

    <comment type="line">//mpConfig 1.3</comment>
    <import>
        import
        <name>
            <name>org</name>
            <operator>.</operator>
            <name>eclipse</name>
            <operator>.</operator>
            <name>microprofile</name>
            <operator>.</operator>
            <name>config</name>
            <operator>.</operator>
            <name>inject</name>
            <operator>.</operator>
            <name>ConfigProperty</name>
        </name>
        ;
    </import>

    <comment type="line">//mpJWT 1.1</comment>
    <import>
        import
        <name>
            <name>org</name>
            <operator>.</operator>
            <name>eclipse</name>
            <operator>.</operator>
            <name>microprofile</name>
            <operator>.</operator>
            <name>auth</name>
            <operator>.</operator>
            <name>LoginConfig</name>
        </name>
        ;
    </import>

    <comment type="line">//mpRestClient 1.3</comment>
    <import>
        import
        <name>
            <name>org</name>
            <operator>.</operator>
            <name>eclipse</name>
            <operator>.</operator>
            <name>microprofile</name>
            <operator>.</operator>
            <name>rest</name>
            <operator>.</operator>
            <name>client</name>
            <operator>.</operator>
            <name>inject</name>
            <operator>.</operator>
            <name>RestClient</name>
        </name>
        ;
    </import>

    <comment type="line">//Servlet 4.0</comment>
    <import>
        import
        <name>
            <name>javax</name>
            <operator>.</operator>
            <name>servlet</name>
            <operator>.</operator>
            <name>http</name>
            <operator>.</operator>
            <name>HttpServletRequest</name>
        </name>
        ;
    </import>

    <comment type="line">//JAX-RS 2.1 (JSR 339)</comment>
    <import>
        import
        <name>
            <name>javax</name>
            <operator>.</operator>
            <name>ws</name>
            <operator>.</operator>
            <name>rs</name>
            <operator>.</operator>
            <name>core</name>
            <operator>.</operator>
            <name>Application</name>
        </name>
        ;
    </import>
    <import>
        import
        <name>
            <name>javax</name>
            <operator>.</operator>
            <name>ws</name>
            <operator>.</operator>
            <name>rs</name>
            <operator>.</operator>
            <name>core</name>
            <operator>.</operator>
            <name>Context</name>
        </name>
        ;
    </import>
    <import>
        import
        <name>
            <name>javax</name>
            <operator>.</operator>
            <name>ws</name>
            <operator>.</operator>
            <name>rs</name>
            <operator>.</operator>
            <name>core</name>
            <operator>.</operator>
            <name>MediaType</name>
        </name>
        ;
    </import>
    <import>
        import
        <name>
            <name>javax</name>
            <operator>.</operator>
            <name>ws</name>
            <operator>.</operator>
            <name>rs</name>
            <operator>.</operator>
            <name>ApplicationPath</name>
        </name>
        ;
    </import>
    <import>
        import
        <name>
            <name>javax</name>
            <operator>.</operator>
            <name>ws</name>
            <operator>.</operator>
            <name>rs</name>
            <operator>.</operator>
            <name>Consumes</name>
        </name>
        ;
    </import>
    <import>
        import
        <name>
            <name>javax</name>
            <operator>.</operator>
            <name>ws</name>
            <operator>.</operator>
            <name>rs</name>
            <operator>.</operator>
            <name>DELETE</name>
        </name>
        ;
    </import>
    <import>
        import
        <name>
            <name>javax</name>
            <operator>.</operator>
            <name>ws</name>
            <operator>.</operator>
            <name>rs</name>
            <operator>.</operator>
            <name>GET</name>
        </name>
        ;
    </import>
    <import>
        import
        <name>
            <name>javax</name>
            <operator>.</operator>
            <name>ws</name>
            <operator>.</operator>
            <name>rs</name>
            <operator>.</operator>
            <name>POST</name>
        </name>
        ;
    </import>
    <import>
        import
        <name>
            <name>javax</name>
            <operator>.</operator>
            <name>ws</name>
            <operator>.</operator>
            <name>rs</name>
            <operator>.</operator>
            <name>PUT</name>
        </name>
        ;
    </import>
    <import>
        import
        <name>
            <name>javax</name>
            <operator>.</operator>
            <name>ws</name>
            <operator>.</operator>
            <name>rs</name>
            <operator>.</operator>
            <name>PathParam</name>
        </name>
        ;
    </import>
    <import>
        import
        <name>
            <name>javax</name>
            <operator>.</operator>
            <name>ws</name>
            <operator>.</operator>
            <name>rs</name>
            <operator>.</operator>
            <name>Produces</name>
        </name>
        ;
    </import>
    <import>
        import
        <name>
            <name>javax</name>
            <operator>.</operator>
            <name>ws</name>
            <operator>.</operator>
            <name>rs</name>
            <operator>.</operator>
            <name>QueryParam</name>
        </name>
        ;
    </import>
    <import>
        import
        <name>
            <name>javax</name>
            <operator>.</operator>
            <name>ws</name>
            <operator>.</operator>
            <name>rs</name>
            <operator>.</operator>
            <name>Path</name>
        </name>
        ;
    </import>

    <class>
        <annotation>
            @
            <name>ApplicationPath</name>
            <argument_list>
                (
                <argument>
                    <expr>
                        <literal type="string">"/"</literal>
                    </expr>
                </argument>
                )
            </argument_list>
        </annotation>
        <annotation>
            @
            <name>Path</name>
            <argument_list>
                (
                <argument>
                    <expr>
                        <literal type="string">"/"</literal>
                    </expr>
                </argument>
                )
            </argument_list>
        </annotation>
        <annotation>
            @
            <name>LoginConfig</name>
            <argument_list>
                (
                <argument>
                    <expr>
                        <name>authMethod</name>
                        <operator>=</operator>
                        <literal type="string">"MP-JWT"</literal>
                    </expr>
                </argument>
                ,
                <argument>
                    <expr>
                        <name>realmName</name>
                        <operator>=</operator>
                        <literal type="string">"jwt-jaspi"</literal>
                    </expr>
                </argument>
                )
            </argument_list>
        </annotation>
        <annotation>
            @
            <name>RequestScoped</name>
        </annotation>
        <comment type="line">//enable interceptors like @Transactional (note you need a WEB-INF/beans.xml in your war)</comment>
        <comment type="block" format="javadoc">/** This microservice is the controller in a model-view-controller architecture, doing the routing and
 *  combination of results from other microservices.  Note that the Portfolio microservice it calls is
 *  mandatory, whereas the Account and TradeHistory microservices are optional.
 */</comment>
        <specifier>public</specifier>
        class
        <name>BrokerService</name>
        <super>
            <extends>
                extends
                <name>Application</name>
            </extends>
        </super>
        <block>
            {
            <decl_stmt>
                <decl>
                    <specifier>private</specifier>
                    <specifier>static</specifier>
                    <type>
                        <name>Logger</name>
                    </type>
                    <name>logger</name>
                    <init>
                        =
                        <expr>
                            <call>
                                <name>
                                    <name>Logger</name>
                                    <operator>.</operator>
                                    <name>getLogger</name>
                                </name>
                                <argument_list>
                                    (
                                    <argument>
                                        <expr>
                                            <call>
                                                <name>
                                                    <name>BrokerService</name>
                                                    <operator>.</operator>
                                                    <name>
                                                        <name>class</name>
                                                        <operator>.</operator>
                                                        <name>getName</name>
                                                    </name>
                                                </name>
                                                <argument_list>()</argument_list>
                                            </call>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                    </init>
                </decl>
                ;
            </decl_stmt>

            <decl_stmt>
                <decl>
                    <specifier>private</specifier>
                    <specifier>static</specifier>
                    <type>
                        <specifier>final</specifier>
                        <name>double</name>
                    </type>
                    <name>DONT_RECALCULATE</name>
                    <init>
                        =
                        <expr>
                            <operator>-</operator>
                            <literal type="number">1.0</literal>
                        </expr>
                    </init>
                </decl>
                ;
            </decl_stmt>

            <decl_stmt>
                <decl>
                    <specifier>private</specifier>
                    <specifier>static</specifier>
                    <type>
                        <name>boolean</name>
                    </type>
                    <name>useAccount</name>
                    <init>
                        =
                        <expr>
                            <literal type="boolean">false</literal>
                        </expr>
                    </init>
                </decl>
                ;
            </decl_stmt>
            <decl_stmt>
                <decl>
                    <specifier>private</specifier>
                    <specifier>static</specifier>
                    <type>
                        <name>boolean</name>
                    </type>
                    <name>useS3</name>
                    <init>
                        =
                        <expr>
                            <literal type="boolean">false</literal>
                        </expr>
                    </init>
                </decl>
                ;
            </decl_stmt>
            <decl_stmt>
                <decl>
                    <specifier>private</specifier>
                    <specifier>static</specifier>
                    <type>
                        <name>boolean</name>
                    </type>
                    <name>useCQRS</name>
                    <init>
                        =
                        <expr>
                            <literal type="boolean">false</literal>
                        </expr>
                    </init>
                </decl>
                ;
            </decl_stmt>
            <decl_stmt>
                <decl>
                    <specifier>private</specifier>
                    <specifier>static</specifier>
                    <type>
                        <name>boolean</name>
                    </type>
                    <name>initialized</name>
                    <init>
                        =
                        <expr>
                            <literal type="boolean">false</literal>
                        </expr>
                    </init>
                </decl>
                ;
            </decl_stmt>
            <decl_stmt>
                <decl>
                    <specifier>private</specifier>
                    <specifier>static</specifier>
                    <type>
                        <name>boolean</name>
                    </type>
                    <name>staticInitialized</name>
                    <init>
                        =
                        <expr>
                            <literal type="boolean">false</literal>
                        </expr>
                    </init>
                </decl>
                ;
            </decl_stmt>

            <decl_stmt>
                <decl>
                    <specifier>private</specifier>
                    <annotation>
                        @
                        <name>Inject</name>
                    </annotation>
                    <annotation>
                        @
                        <name>RestClient</name>
                    </annotation>
                    <type>
                        <name>PortfolioClient</name>
                    </type>
                    <name>portfolioClient</name>
                </decl>
                ;
            </decl_stmt>
            <decl_stmt>
                <decl>
                    <specifier>private</specifier>
                    <annotation>
                        @
                        <name>Inject</name>
                    </annotation>
                    <annotation>
                        @
                        <name>RestClient</name>
                    </annotation>
                    <type>
                        <name>AccountClient</name>
                    </type>
                    <name>accountClient</name>
                </decl>
                ;
            </decl_stmt>
            <decl_stmt>
                <decl>
                    <specifier>private</specifier>
                    <annotation>
                        @
                        <name>Inject</name>
                    </annotation>
                    <annotation>
                        @
                        <name>RestClient</name>
                    </annotation>
                    <type>
                        <name>TradeHistoryClient</name>
                    </type>
                    <name>tradeHistoryClient</name>
                </decl>
                ;
            </decl_stmt>

            <comment type="line">// Override ODM Client URL if secret is configured to provide URL</comment>
            <static>
                static
                <block>
                    {
                    <expr_stmt>
                        <expr>
                            <name>useAccount</name>
                            <operator>=</operator>
                            <call>
                                <name>
                                    <name>Boolean</name>
                                    <operator>.</operator>
                                    <name>parseBoolean</name>
                                </name>
                                <argument_list>
                                    (
                                    <argument>
                                        <expr>
                                            <call>
                                                <name>
                                                    <name>System</name>
                                                    <operator>.</operator>
                                                    <name>getenv</name>
                                                </name>
                                                <argument_list>
                                                    (
                                                    <argument>
                                                        <expr>
                                                            <literal type="string">"ACCOUNT_ENABLED"</literal>
                                                        </expr>
                                                    </argument>
                                                    )
                                                </argument_list>
                                            </call>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>
                    <expr_stmt>
                        <expr>
                            <call>
                                <name>
                                    <name>logger</name>
                                    <operator>.</operator>
                                    <name>info</name>
                                </name>
                                <argument_list>
                                    (
                                    <argument>
                                        <expr>
                                            <literal type="string">"Account microservice enabled: "</literal>
                                            <operator>+</operator>
                                            <name>useAccount</name>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>

                    <expr_stmt>
                        <expr>
                            <name>useS3</name>
                            <operator>=</operator>
                            <call>
                                <name>
                                    <name>Boolean</name>
                                    <operator>.</operator>
                                    <name>parseBoolean</name>
                                </name>
                                <argument_list>
                                    (
                                    <argument>
                                        <expr>
                                            <call>
                                                <name>
                                                    <name>System</name>
                                                    <operator>.</operator>
                                                    <name>getenv</name>
                                                </name>
                                                <argument_list>
                                                    (
                                                    <argument>
                                                        <expr>
                                                            <literal type="string">"S3_ENABLED"</literal>
                                                        </expr>
                                                    </argument>
                                                    )
                                                </argument_list>
                                            </call>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>
                    <expr_stmt>
                        <expr>
                            <call>
                                <name>
                                    <name>logger</name>
                                    <operator>.</operator>
                                    <name>info</name>
                                </name>
                                <argument_list>
                                    (
                                    <argument>
                                        <expr>
                                            <literal type="string">"S3 enabled: "</literal>
                                            <operator>+</operator>
                                            <name>useS3</name>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>

                    <expr_stmt>
                        <expr>
                            <name>useCQRS</name>
                            <operator>=</operator>
                            <call>
                                <name>
                                    <name>Boolean</name>
                                    <operator>.</operator>
                                    <name>parseBoolean</name>
                                </name>
                                <argument_list>
                                    (
                                    <argument>
                                        <expr>
                                            <call>
                                                <name>
                                                    <name>System</name>
                                                    <operator>.</operator>
                                                    <name>getenv</name>
                                                </name>
                                                <argument_list>
                                                    (
                                                    <argument>
                                                        <expr>
                                                            <literal type="string">"CQRS_ENABLED"</literal>
                                                        </expr>
                                                    </argument>
                                                    )
                                                </argument_list>
                                            </call>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>
                    <expr_stmt>
                        <expr>
                            <call>
                                <name>
                                    <name>logger</name>
                                    <operator>.</operator>
                                    <name>info</name>
                                </name>
                                <argument_list>
                                    (
                                    <argument>
                                        <expr>
                                            <literal type="string">"CQRS enabled: "</literal>
                                            <operator>+</operator>
                                            <name>useCQRS</name>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>

                    <decl_stmt>
                        <decl>
                            <type>
                                <name>String</name>
                            </type>
                            <name>mpUrlPropName</name>
                            <init>
                                =
                                <expr>
                                    <call>
                                        <name>
                                            <name>PortfolioClient</name>
                                            <operator>.</operator>
                                            <name>
                                                <name>class</name>
                                                <operator>.</operator>
                                                <name>getName</name>
                                            </name>
                                        </name>
                                        <argument_list>()</argument_list>
                                    </call>
                                    <operator>+</operator>
                                    <literal type="string">"/mp-rest/url"</literal>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>String</name>
                            </type>
                            <name>urlFromEnv</name>
                            <init>
                                =
                                <expr>
                                    <call>
                                        <name>
                                            <name>System</name>
                                            <operator>.</operator>
                                            <name>getenv</name>
                                        </name>
                                        <argument_list>
                                            (
                                            <argument>
                                                <expr>
                                                    <literal type="string">"PORTFOLIO_URL"</literal>
                                                </expr>
                                            </argument>
                                            )
                                        </argument_list>
                                    </call>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <if>
                        if
                        <condition>
                            (
                            <expr>
                                <operator>(</operator>
                                <name>urlFromEnv</name>
                                <operator>!=</operator>
                                <literal type="null">null</literal>
                                <operator>)</operator>
                                <operator>&amp;&amp;</operator>
                                <operator>!</operator>
                                <call>
                                    <name>
                                        <name>urlFromEnv</name>
                                        <operator>.</operator>
                                        <name>isEmpty</name>
                                    </name>
                                    <argument_list>()</argument_list>
                                </call>
                            </expr>
                            )
                        </condition>
                        <then>
                            <block>
                                {
                                <expr_stmt>
                                    <expr>
                                        <call>
                                            <name>
                                                <name>logger</name>
                                                <operator>.</operator>
                                                <name>info</name>
                                            </name>
                                            <argument_list>
                                                (
                                                <argument>
                                                    <expr>
                                                        <literal type="string">"Using Portfolio URL from config map: "</literal>
                                                        <operator>+</operator>
                                                        <name>urlFromEnv</name>
                                                    </expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>
                                <expr_stmt>
                                    <expr>
                                        <call>
                                            <name>
                                                <name>System</name>
                                                <operator>.</operator>
                                                <name>setProperty</name>
                                            </name>
                                            <argument_list>
                                                (
                                                <argument>
                                                    <expr>
                                                        <name>mpUrlPropName</name>
                                                    </expr>
                                                </argument>
                                                ,
                                                <argument>
                                                    <expr>
                                                        <name>urlFromEnv</name>
                                                    </expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>
                                }
                            </block>
                        </then>
                        <else>
                            else
                            <block>
                                {
                                <expr_stmt>
                                    <expr>
                                        <call>
                                            <name>
                                                <name>logger</name>
                                                <operator>.</operator>
                                                <name>info</name>
                                            </name>
                                            <argument_list>
                                                (
                                                <argument>
                                                    <expr>
                                                        <literal type="string">"Portfolio URL not found from env var from config map, so defaulting to value in jvm.options: "</literal>
                                                        <operator>+</operator>
                                                        <call>
                                                            <name>
                                                                <name>System</name>
                                                                <operator>.</operator>
                                                                <name>getProperty</name>
                                                            </name>
                                                            <argument_list>
                                                                (
                                                                <argument>
                                                                    <expr>
                                                                        <name>mpUrlPropName</name>
                                                                    </expr>
                                                                </argument>
                                                                )
                                                            </argument_list>
                                                        </call>
                                                    </expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>
                                }
                            </block>
                        </else>
                    </if>

                    <expr_stmt>
                        <expr>
                            <name>mpUrlPropName</name>
                            <operator>=</operator>
                            <call>
                                <name>
                                    <name>AccountClient</name>
                                    <operator>.</operator>
                                    <name>
                                        <name>class</name>
                                        <operator>.</operator>
                                        <name>getName</name>
                                    </name>
                                </name>
                                <argument_list>()</argument_list>
                            </call>
                            <operator>+</operator>
                            <literal type="string">"/mp-rest/url"</literal>
                        </expr>
                        ;
                    </expr_stmt>
                    <expr_stmt>
                        <expr>
                            <name>urlFromEnv</name>
                            <operator>=</operator>
                            <call>
                                <name>
                                    <name>System</name>
                                    <operator>.</operator>
                                    <name>getenv</name>
                                </name>
                                <argument_list>
                                    (
                                    <argument>
                                        <expr>
                                            <literal type="string">"ACCOUNT_URL"</literal>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>
                    <if>
                        if
                        <condition>
                            (
                            <expr>
                                <operator>(</operator>
                                <name>urlFromEnv</name>
                                <operator>!=</operator>
                                <literal type="null">null</literal>
                                <operator>)</operator>
                                <operator>&amp;&amp;</operator>
                                <operator>!</operator>
                                <call>
                                    <name>
                                        <name>urlFromEnv</name>
                                        <operator>.</operator>
                                        <name>isEmpty</name>
                                    </name>
                                    <argument_list>()</argument_list>
                                </call>
                            </expr>
                            )
                        </condition>
                        <then>
                            <block>
                                {
                                <expr_stmt>
                                    <expr>
                                        <call>
                                            <name>
                                                <name>logger</name>
                                                <operator>.</operator>
                                                <name>info</name>
                                            </name>
                                            <argument_list>
                                                (
                                                <argument>
                                                    <expr>
                                                        <literal type="string">"Using Account URL from config map: "</literal>
                                                        <operator>+</operator>
                                                        <name>urlFromEnv</name>
                                                    </expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>
                                <expr_stmt>
                                    <expr>
                                        <call>
                                            <name>
                                                <name>System</name>
                                                <operator>.</operator>
                                                <name>setProperty</name>
                                            </name>
                                            <argument_list>
                                                (
                                                <argument>
                                                    <expr>
                                                        <name>mpUrlPropName</name>
                                                    </expr>
                                                </argument>
                                                ,
                                                <argument>
                                                    <expr>
                                                        <name>urlFromEnv</name>
                                                    </expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>
                                }
                            </block>
                        </then>
                        <else>
                            else
                            <block>
                                {
                                <expr_stmt>
                                    <expr>
                                        <call>
                                            <name>
                                                <name>logger</name>
                                                <operator>.</operator>
                                                <name>info</name>
                                            </name>
                                            <argument_list>
                                                (
                                                <argument>
                                                    <expr>
                                                        <literal type="string">"Account URL not found from env var from config map, so defaulting to value in jvm.options: "</literal>
                                                        <operator>+</operator>
                                                        <call>
                                                            <name>
                                                                <name>System</name>
                                                                <operator>.</operator>
                                                                <name>getProperty</name>
                                                            </name>
                                                            <argument_list>
                                                                (
                                                                <argument>
                                                                    <expr>
                                                                        <name>mpUrlPropName</name>
                                                                    </expr>
                                                                </argument>
                                                                )
                                                            </argument_list>
                                                        </call>
                                                    </expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>
                                }
                            </block>
                        </else>
                    </if>

                    <expr_stmt>
                        <expr>
                            <name>mpUrlPropName</name>
                            <operator>=</operator>
                            <call>
                                <name>
                                    <name>TradeHistoryClient</name>
                                    <operator>.</operator>
                                    <name>
                                        <name>class</name>
                                        <operator>.</operator>
                                        <name>getName</name>
                                    </name>
                                </name>
                                <argument_list>()</argument_list>
                            </call>
                            <operator>+</operator>
                            <literal type="string">"/mp-rest/url"</literal>
                        </expr>
                        ;
                    </expr_stmt>
                    <expr_stmt>
                        <expr>
                            <name>urlFromEnv</name>
                            <operator>=</operator>
                            <call>
                                <name>
                                    <name>System</name>
                                    <operator>.</operator>
                                    <name>getenv</name>
                                </name>
                                <argument_list>
                                    (
                                    <argument>
                                        <expr>
                                            <literal type="string">"TRADE_HISTORY_URL"</literal>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>
                    <if>
                        if
                        <condition>
                            (
                            <expr>
                                <operator>(</operator>
                                <name>urlFromEnv</name>
                                <operator>!=</operator>
                                <literal type="null">null</literal>
                                <operator>)</operator>
                                <operator>&amp;&amp;</operator>
                                <operator>!</operator>
                                <call>
                                    <name>
                                        <name>urlFromEnv</name>
                                        <operator>.</operator>
                                        <name>isEmpty</name>
                                    </name>
                                    <argument_list>()</argument_list>
                                </call>
                            </expr>
                            )
                        </condition>
                        <then>
                            <block>
                                {
                                <expr_stmt>
                                    <expr>
                                        <call>
                                            <name>
                                                <name>logger</name>
                                                <operator>.</operator>
                                                <name>info</name>
                                            </name>
                                            <argument_list>
                                                (
                                                <argument>
                                                    <expr>
                                                        <literal type="string">"Using Trade History URL from config map: "</literal>
                                                        <operator>+</operator>
                                                        <name>urlFromEnv</name>
                                                    </expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>
                                <expr_stmt>
                                    <expr>
                                        <call>
                                            <name>
                                                <name>System</name>
                                                <operator>.</operator>
                                                <name>setProperty</name>
                                            </name>
                                            <argument_list>
                                                (
                                                <argument>
                                                    <expr>
                                                        <name>mpUrlPropName</name>
                                                    </expr>
                                                </argument>
                                                ,
                                                <argument>
                                                    <expr>
                                                        <name>urlFromEnv</name>
                                                    </expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>
                                }
                            </block>
                        </then>
                        <else>
                            else
                            <block>
                                {
                                <expr_stmt>
                                    <expr>
                                        <call>
                                            <name>
                                                <name>logger</name>
                                                <operator>.</operator>
                                                <name>info</name>
                                            </name>
                                            <argument_list>
                                                (
                                                <argument>
                                                    <expr>
                                                        <literal type="string">"Trade History URL not found from env var from config map, so defaulting to value in jvm.options: "</literal>
                                                        <operator>+</operator>
                                                        <call>
                                                            <name>
                                                                <name>System</name>
                                                                <operator>.</operator>
                                                                <name>getProperty</name>
                                                            </name>
                                                            <argument_list>
                                                                (
                                                                <argument>
                                                                    <expr>
                                                                        <name>mpUrlPropName</name>
                                                                    </expr>
                                                                </argument>
                                                                )
                                                            </argument_list>
                                                        </call>
                                                    </expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>
                                }
                            </block>
                        </else>
                    </if>
                    }
                </block>
            </static>

            <function>
                <annotation>
                    @
                    <name>GET</name>
                </annotation>
                <annotation>
                    @
                    <name>Path</name>
                    <argument_list>
                        (
                        <argument>
                            <expr>
                                <literal type="string">"/"</literal>
                            </expr>
                        </argument>
                        )
                    </argument_list>
                </annotation>
                <annotation>
                    @
                    <name>Produces</name>
                    <argument_list>
                        (
                        <argument>
                            <expr>
                                <name>
                                    <name>MediaType</name>
                                    <operator>.</operator>
                                    <name>APPLICATION_JSON</name>
                                </name>
                            </expr>
                        </argument>
                        )
                    </argument_list>
                </annotation>
                <comment type="line">//	@RolesAllowed({"StockTrader", "StockViewer"}) //Couldn't get this to work; had to do it through the web.xml instead :(</comment>
                <specifier>public</specifier>
                <type>
                    <name>
                        <name>Broker</name>
                        <index>[]</index>
                    </name>
                </type>
                <name>getBrokers</name>
                <parameter_list>
                    (
                    <parameter>
                        <decl>
                            <type>
                                <annotation>
                                    @
                                    <name>Context</name>
                                </annotation>
                                <name>HttpServletRequest</name>
                            </type>
                            <name>request</name>
                        </decl>
                    </parameter>
                    )
                </parameter_list>
                <block>
                    {
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>String</name>
                            </type>
                            <name>jwt</name>
                            <init>
                                =
                                <expr>
                                    <call>
                                        <name>
                                            <name>request</name>
                                            <operator>.</operator>
                                            <name>getHeader</name>
                                        </name>
                                        <argument_list>
                                            (
                                            <argument>
                                                <expr>
                                                    <literal type="string">"Authorization"</literal>
                                                </expr>
                                            </argument>
                                            )
                                        </argument_list>
                                    </call>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>

                    <if>
                        if
                        <condition>
                            (
                            <expr>
                                <name>useCQRS</name>
                            </expr>
                            )
                        </condition>
                        <then>
                            <block>
                                {
                                <expr_stmt>
                                    <expr>
                                        <call>
                                            <name>
                                                <name>logger</name>
                                                <operator>.</operator>
                                                <name>info</name>
                                            </name>
                                            <argument_list>
                                                (
                                                <argument>
                                                    <expr>
                                                        <literal type="string">"getBrokers: Placeholder for when CQRS support is added"</literal>
                                                    </expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>
                                }
                            </block>
                        </then>
                    </if>

                    <expr_stmt>
                        <expr>
                            <call>
                                <name>
                                    <name>logger</name>
                                    <operator>.</operator>
                                    <name>fine</name>
                                </name>
                                <argument_list>
                                    (
                                    <argument>
                                        <expr>
                                            <literal type="string">"Calling PortfolioClient.getPortfolios()"</literal>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>
                                    <name>Portfolio</name>
                                    <index>[]</index>
                                </name>
                            </type>
                            <name>portfolios</name>
                            <init>
                                =
                                <expr>
                                    <call>
                                        <name>
                                            <name>portfolioClient</name>
                                            <operator>.</operator>
                                            <name>getPortfolios</name>
                                        </name>
                                        <argument_list>
                                            (
                                            <argument>
                                                <expr>
                                                    <name>jwt</name>
                                                </expr>
                                            </argument>
                                            )
                                        </argument_list>
                                    </call>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>

                    <decl_stmt>
                        <decl>
                            <type>
                                <name>int</name>
                            </type>
                            <name>portfolioCount</name>
                            <init>
                                =
                                <expr>
                                    <literal type="number">0</literal>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>
                                    <name>Broker</name>
                                    <index>[]</index>
                                </name>
                            </type>
                            <name>brokers</name>
                            <init>
                                =
                                <expr>
                                    <literal type="null">null</literal>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <if>
                        if
                        <condition>
                            (
                            <expr>
                                <name>portfolios</name>
                                <operator>!=</operator>
                                <literal type="null">null</literal>
                            </expr>
                            )
                        </condition>
                        <then>
                            <block>
                                {
                                <expr_stmt>
                                    <expr>
                                        <name>portfolioCount</name>
                                        <operator>=</operator>
                                        <name>
                                            <name>portfolios</name>
                                            <operator>.</operator>
                                            <name>length</name>
                                        </name>
                                    </expr>
                                    ;
                                </expr_stmt>
                                <decl_stmt>
                                    <decl>
                                        <type>
                                            <name>int</name>
                                        </type>
                                        <name>accountCount</name>
                                        <init>
                                            =
                                            <expr>
                                                <literal type="number">0</literal>
                                            </expr>
                                        </init>
                                    </decl>
                                    ;
                                </decl_stmt>

                                <expr_stmt>
                                    <expr>
                                        <name>brokers</name>
                                        <operator>=</operator>
                                        <operator>new</operator>
                                        <name>
                                            <name>Broker</name>
                                            <index>
                                                [
                                                <expr>
                                                    <name>portfolioCount</name>
                                                </expr>
                                                ]
                                            </index>
                                        </name>
                                    </expr>
                                    ;
                                </expr_stmt>
                                <decl_stmt>
                                    <decl>
                                        <type>
                                            <name>
                                                <name>Account</name>
                                                <index>[]</index>
                                            </name>
                                        </type>
                                        <name>accounts</name>
                                        <init>
                                            =
                                            <expr>
                                                <operator>new</operator>
                                                <name>
                                                    <name>Account</name>
                                                    <index>
                                                        [
                                                        <expr>
                                                            <name>portfolioCount</name>
                                                        </expr>
                                                        ]
                                                    </index>
                                                </name>
                                            </expr>
                                        </init>
                                    </decl>
                                    ;
                                </decl_stmt>

                                <if>
                                    if
                                    <condition>
                                        (
                                        <expr>
                                            <name>useAccount</name>
                                        </expr>
                                        )
                                    </condition>
                                    <then>
                                        <block type="pseudo">
                                            <try>
                                                try
                                                <block>
                                                    {
                                                    <expr_stmt>
                                                        <expr>
                                                            <call>
                                                                <name>
                                                                    <name>logger</name>
                                                                    <operator>.</operator>
                                                                    <name>fine</name>
                                                                </name>
                                                                <argument_list>
                                                                    (
                                                                    <argument>
                                                                        <expr>
                                                                            <literal type="string">"Calling AccountClient.getAccounts()"</literal>
                                                                        </expr>
                                                                    </argument>
                                                                    )
                                                                </argument_list>
                                                            </call>
                                                        </expr>
                                                        ;
                                                    </expr_stmt>
                                                    <expr_stmt>
                                                        <expr>
                                                            <name>accounts</name>
                                                            <operator>=</operator>
                                                            <call>
                                                                <name>
                                                                    <name>accountClient</name>
                                                                    <operator>.</operator>
                                                                    <name>getAccounts</name>
                                                                </name>
                                                                <argument_list>
                                                                    (
                                                                    <argument>
                                                                        <expr>
                                                                            <name>jwt</name>
                                                                        </expr>
                                                                    </argument>
                                                                    )
                                                                </argument_list>
                                                            </call>
                                                        </expr>
                                                        ;
                                                    </expr_stmt>
                                                    <expr_stmt>
                                                        <expr>
                                                            <name>accountCount</name>
                                                            <operator>=</operator>
                                                            <name>
                                                                <name>accounts</name>
                                                                <operator>.</operator>
                                                                <name>length</name>
                                                            </name>
                                                        </expr>
                                                        ;
                                                    </expr_stmt>
                                                    }
                                                </block>
                                                <catch>
                                                    catch
                                                    <parameter_list>
                                                        (
                                                        <parameter>
                                                            <decl>
                                                                <type>
                                                                    <name>Throwable</name>
                                                                </type>
                                                                <name>t</name>
                                                            </decl>
                                                        </parameter>
                                                        )
                                                    </parameter_list>
                                                    <block>
                                                        {
                                                        <expr_stmt>
                                                            <expr>
                                                                <call>
                                                                    <name>logException</name>
                                                                    <argument_list>
                                                                        (
                                                                        <argument>
                                                                            <expr>
                                                                                <name>t</name>
                                                                            </expr>
                                                                        </argument>
                                                                        )
                                                                    </argument_list>
                                                                </call>
                                                            </expr>
                                                            ;
                                                        </expr_stmt>
                                                        }
                                                    </block>
                                                </catch>
                                            </try>
                                        </block>
                                    </then>
                                </if>

                                <comment type="line">//Since the accounts are likely not in the same order as the portfolios, need to match them up</comment>
                                <comment type="line">//TODO: Consider making both use an "ORDER BY owner", so we don't have to do this</comment>
                                <decl_stmt>
                                    <decl>
                                        <type>
                                            <name>Portfolio</name>
                                        </type>
                                        <name>portfolio</name>
                                        <init>
                                            =
                                            <expr>
                                                <literal type="null">null</literal>
                                            </expr>
                                        </init>
                                    </decl>
                                    ;
                                </decl_stmt>
                                <for>
                                    for
                                    <control>
                                        (
                                        <init>
                                            <decl>
                                                <type>
                                                    <name>int</name>
                                                </type>
                                                <name>outerIndex</name>
                                                <init>
                                                    =
                                                    <expr>
                                                        <literal type="number">0</literal>
                                                    </expr>
                                                </init>
                                            </decl>
                                            ;
                                        </init>
                                        <condition>
                                            <expr>
                                                <name>outerIndex</name>
                                                <operator>&lt;</operator>
                                                <name>portfolioCount</name>
                                            </expr>
                                            ;
                                        </condition>
                                        <incr>
                                            <expr>
                                                <name>outerIndex</name>
                                                <operator>++</operator>
                                            </expr>
                                        </incr>
                                        )
                                    </control>
                                    <block>
                                        {
                                        <expr_stmt>
                                            <expr>
                                                <name>portfolio</name>
                                                <operator>=</operator>
                                                <name>
                                                    <name>portfolios</name>
                                                    <index>
                                                        [
                                                        <expr>
                                                            <name>outerIndex</name>
                                                        </expr>
                                                        ]
                                                    </index>
                                                </name>
                                            </expr>
                                            ;
                                        </expr_stmt>
                                        <decl_stmt>
                                            <decl>
                                                <type>
                                                    <name>String</name>
                                                </type>
                                                <name>owner</name>
                                                <init>
                                                    =
                                                    <expr>
                                                        <call>
                                                            <name>
                                                                <name>portfolio</name>
                                                                <operator>.</operator>
                                                                <name>getOwner</name>
                                                            </name>
                                                            <argument_list>()</argument_list>
                                                        </call>
                                                    </expr>
                                                </init>
                                            </decl>
                                            ;
                                        </decl_stmt>
                                        <decl_stmt>
                                            <decl>
                                                <type>
                                                    <name>Account</name>
                                                </type>
                                                <name>account</name>
                                                <init>
                                                    =
                                                    <expr>
                                                        <literal type="null">null</literal>
                                                    </expr>
                                                </init>
                                            </decl>
                                            ;
                                        </decl_stmt>
                                        <for>
                                            for
                                            <control>
                                                (
                                                <init>
                                                    <decl>
                                                        <type>
                                                            <name>int</name>
                                                        </type>
                                                        <name>innerIndex</name>
                                                        <init>
                                                            =
                                                            <expr>
                                                                <literal type="number">0</literal>
                                                            </expr>
                                                        </init>
                                                    </decl>
                                                    ;
                                                </init>
                                                <condition>
                                                    <expr>
                                                        <name>innerIndex</name>
                                                        <operator>&lt;</operator>
                                                        <name>accountCount</name>
                                                    </expr>
                                                    ;
                                                </condition>
                                                <incr>
                                                    <expr>
                                                        <name>innerIndex</name>
                                                        <operator>++</operator>
                                                    </expr>
                                                </incr>
                                                )
                                            </control>
                                            <block>
                                                {
                                                <expr_stmt>
                                                    <expr>
                                                        <name>account</name>
                                                        <operator>=</operator>
                                                        <name>
                                                            <name>accounts</name>
                                                            <index>
                                                                [
                                                                <expr>
                                                                    <name>innerIndex</name>
                                                                </expr>
                                                                ]
                                                            </index>
                                                        </name>
                                                    </expr>
                                                    ;
                                                </expr_stmt>
                                                <if>
                                                    if
                                                    <condition>
                                                        (
                                                        <expr>
                                                            <call>
                                                                <name>
                                                                    <name>owner</name>
                                                                    <operator>.</operator>
                                                                    <name>equals</name>
                                                                </name>
                                                                <argument_list>
                                                                    (
                                                                    <argument>
                                                                        <expr>
                                                                            <call>
                                                                                <name>
                                                                                    <name>account</name>
                                                                                    <operator>.</operator>
                                                                                    <name>getOwner</name>
                                                                                </name>
                                                                                <argument_list>()</argument_list>
                                                                            </call>
                                                                        </expr>
                                                                    </argument>
                                                                    )
                                                                </argument_list>
                                                            </call>
                                                        </expr>
                                                        )
                                                    </condition>
                                                    <then>
                                                        <block>
                                                            {
                                                            <expr_stmt>
                                                                <expr>
                                                                    <name>
                                                                        <name>brokers</name>
                                                                        <index>
                                                                            [
                                                                            <expr>
                                                                                <name>outerIndex</name>
                                                                            </expr>
                                                                            ]
                                                                        </index>
                                                                    </name>
                                                                    <operator>=</operator>
                                                                    <operator>new</operator>
                                                                    <call>
                                                                        <name>Broker</name>
                                                                        <argument_list>
                                                                            (
                                                                            <argument>
                                                                                <expr>
                                                                                    <name>portfolio</name>
                                                                                </expr>
                                                                            </argument>
                                                                            ,
                                                                            <argument>
                                                                                <expr>
                                                                                    <name>account</name>
                                                                                </expr>
                                                                            </argument>
                                                                            )
                                                                        </argument_list>
                                                                    </call>
                                                                </expr>
                                                                ;
                                                            </expr_stmt>
                                                            <expr_stmt>
                                                                <expr>
                                                                    <call>
                                                                        <name>
                                                                            <name>logger</name>
                                                                            <operator>.</operator>
                                                                            <name>finer</name>
                                                                        </name>
                                                                        <argument_list>
                                                                            (
                                                                            <argument>
                                                                                <expr>
                                                                                    <literal type="string">"Found account corresponding to the portfolio for "</literal>
                                                                                    <operator>+</operator>
                                                                                    <name>owner</name>
                                                                                </expr>
                                                                            </argument>
                                                                            )
                                                                        </argument_list>
                                                                    </call>
                                                                </expr>
                                                                ;
                                                            </expr_stmt>
                                                            <break>break;</break>
                                                            }
                                                        </block>
                                                    </then>
                                                </if>
                                                <expr_stmt>
                                                    <expr>
                                                        <name>account</name>
                                                        <operator>=</operator>
                                                        <literal type="null">null</literal>
                                                    </expr>
                                                    ;
                                                </expr_stmt>
                                                }
                                            </block>
                                        </for>
                                        <if>
                                            if
                                            <condition>
                                                (
                                                <expr>
                                                    <name>account</name>
                                                    <operator>==</operator>
                                                    <literal type="null">null</literal>
                                                </expr>
                                                )
                                            </condition>
                                            <then>
                                                <block>
                                                    {
                                                    <expr_stmt>
                                                        <expr>
                                                            <call>
                                                                <name>
                                                                    <name>logger</name>
                                                                    <operator>.</operator>
                                                                    <name>finer</name>
                                                                </name>
                                                                <argument_list>
                                                                    (
                                                                    <argument>
                                                                        <expr>
                                                                            <literal type="string">"Did not find account corresponding to the portfolio for "</literal>
                                                                            <operator>+</operator>
                                                                            <name>owner</name>
                                                                        </expr>
                                                                    </argument>
                                                                    )
                                                                </argument_list>
                                                            </call>
                                                        </expr>
                                                        ;
                                                    </expr_stmt>
                                                    <expr_stmt>
                                                        <expr>
                                                            <name>
                                                                <name>brokers</name>
                                                                <index>
                                                                    [
                                                                    <expr>
                                                                        <name>outerIndex</name>
                                                                    </expr>
                                                                    ]
                                                                </index>
                                                            </name>
                                                            <operator>=</operator>
                                                            <operator>new</operator>
                                                            <call>
                                                                <name>Broker</name>
                                                                <argument_list>
                                                                    (
                                                                    <argument>
                                                                        <expr>
                                                                            <name>portfolio</name>
                                                                        </expr>
                                                                    </argument>
                                                                    ,
                                                                    <argument>
                                                                        <expr>
                                                                            <literal type="null">null</literal>
                                                                        </expr>
                                                                    </argument>
                                                                    )
                                                                </argument_list>
                                                            </call>
                                                        </expr>
                                                        ;
                                                    </expr_stmt>
                                                    }
                                                </block>
                                            </then>
                                        </if>
                                        }
                                    </block>
                                </for>
                                }
                            </block>
                        </then>
                    </if>

                    <expr_stmt>
                        <expr>
                            <call>
                                <name>
                                    <name>logger</name>
                                    <operator>.</operator>
                                    <name>fine</name>
                                </name>
                                <argument_list>
                                    (
                                    <argument>
                                        <expr>
                                            <literal type="string">"Returning "</literal>
                                            <operator>+</operator>
                                            <name>portfolioCount</name>
                                            <operator>+</operator>
                                            <literal type="string">" portfolios"</literal>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>

                    <return>
                        return
                        <expr>
                            <name>brokers</name>
                        </expr>
                        ;
                    </return>
                    }
                </block>
            </function>

            <function>
                <annotation>
                    @
                    <name>POST</name>
                </annotation>
                <annotation>
                    @
                    <name>Path</name>
                    <argument_list>
                        (
                        <argument>
                            <expr>
                                <literal type="string">"/{owner}"</literal>
                            </expr>
                        </argument>
                        )
                    </argument_list>
                </annotation>
                <annotation>
                    @
                    <name>Produces</name>
                    <argument_list>
                        (
                        <argument>
                            <expr>
                                <name>
                                    <name>MediaType</name>
                                    <operator>.</operator>
                                    <name>APPLICATION_JSON</name>
                                </name>
                            </expr>
                        </argument>
                        )
                    </argument_list>
                </annotation>
                <comment type="line">//	@RolesAllowed({"StockTrader"}) //Couldn't get this to work; had to do it through the web.xml instead :(</comment>
                <specifier>public</specifier>
                <type>
                    <name>Broker</name>
                </type>
                <name>createBroker</name>
                <parameter_list>
                    (
                    <parameter>
                        <decl>
                            <type>
                                <annotation>
                                    @
                                    <name>PathParam</name>
                                    <argument_list>
                                        (
                                        <argument>
                                            <expr>
                                                <literal type="string">"owner"</literal>
                                            </expr>
                                        </argument>
                                        )
                                    </argument_list>
                                </annotation>
                                <name>String</name>
                            </type>
                            <name>owner</name>
                        </decl>
                    </parameter>
                    ,
                    <parameter>
                        <decl>
                            <type>
                                <annotation>
                                    @
                                    <name>Context</name>
                                </annotation>
                                <name>HttpServletRequest</name>
                            </type>
                            <name>request</name>
                        </decl>
                    </parameter>
                    )
                </parameter_list>
                <block>
                    {
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>Broker</name>
                            </type>
                            <name>broker</name>
                            <init>
                                =
                                <expr>
                                    <literal type="null">null</literal>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>Portfolio</name>
                            </type>
                            <name>portfolio</name>
                            <init>
                                =
                                <expr>
                                    <literal type="null">null</literal>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>String</name>
                            </type>
                            <name>jwt</name>
                            <init>
                                =
                                <expr>
                                    <call>
                                        <name>
                                            <name>request</name>
                                            <operator>.</operator>
                                            <name>getHeader</name>
                                        </name>
                                        <argument_list>
                                            (
                                            <argument>
                                                <expr>
                                                    <literal type="string">"Authorization"</literal>
                                                </expr>
                                            </argument>
                                            )
                                        </argument_list>
                                    </call>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>

                    <decl_stmt>
                        <decl>
                            <type>
                                <name>Account</name>
                            </type>
                            <name>account</name>
                            <init>
                                =
                                <expr>
                                    <literal type="null">null</literal>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>String</name>
                            </type>
                            <name>accountID</name>
                            <init>
                                =
                                <expr>
                                    <literal type="null">null</literal>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <if>
                        if
                        <condition>
                            (
                            <expr>
                                <name>useAccount</name>
                            </expr>
                            )
                        </condition>
                        <then>
                            <block type="pseudo">
                                <try>
                                    try
                                    <block>
                                        {
                                        <expr_stmt>
                                            <expr>
                                                <call>
                                                    <name>
                                                        <name>logger</name>
                                                        <operator>.</operator>
                                                        <name>fine</name>
                                                    </name>
                                                    <argument_list>
                                                        (
                                                        <argument>
                                                            <expr>
                                                                <literal type="string">"Calling AccountClient.createAccount()"</literal>
                                                            </expr>
                                                        </argument>
                                                        )
                                                    </argument_list>
                                                </call>
                                            </expr>
                                            ;
                                        </expr_stmt>
                                        <expr_stmt>
                                            <expr>
                                                <name>account</name>
                                                <operator>=</operator>
                                                <call>
                                                    <name>
                                                        <name>accountClient</name>
                                                        <operator>.</operator>
                                                        <name>createAccount</name>
                                                    </name>
                                                    <argument_list>
                                                        (
                                                        <argument>
                                                            <expr>
                                                                <name>jwt</name>
                                                            </expr>
                                                        </argument>
                                                        ,
                                                        <argument>
                                                            <expr>
                                                                <name>owner</name>
                                                            </expr>
                                                        </argument>
                                                        )
                                                    </argument_list>
                                                </call>
                                            </expr>
                                            ;
                                        </expr_stmt>
                                        <if>
                                            if
                                            <condition>
                                                (
                                                <expr>
                                                    <name>account</name>
                                                    <operator>!=</operator>
                                                    <literal type="null">null</literal>
                                                </expr>
                                                )
                                            </condition>
                                            <then>
                                                <block type="pseudo">
                                                    <expr_stmt>
                                                        <expr>
                                                            <name>accountID</name>
                                                            <operator>=</operator>
                                                            <call>
                                                                <name>
                                                                    <name>account</name>
                                                                    <operator>.</operator>
                                                                    <name>get_id</name>
                                                                </name>
                                                                <argument_list>()</argument_list>
                                                            </call>
                                                        </expr>
                                                        ;
                                                    </expr_stmt>
                                                </block>
                                            </then>
                                        </if>
                                        }
                                    </block>
                                    <catch>
                                        catch
                                        <parameter_list>
                                            (
                                            <parameter>
                                                <decl>
                                                    <type>
                                                        <name>Throwable</name>
                                                    </type>
                                                    <name>t</name>
                                                </decl>
                                            </parameter>
                                            )
                                        </parameter_list>
                                        <block>
                                            {
                                            <expr_stmt>
                                                <expr>
                                                    <call>
                                                        <name>logException</name>
                                                        <argument_list>
                                                            (
                                                            <argument>
                                                                <expr>
                                                                    <name>t</name>
                                                                </expr>
                                                            </argument>
                                                            )
                                                        </argument_list>
                                                    </call>
                                                </expr>
                                                ;
                                            </expr_stmt>
                                            }
                                        </block>
                                    </catch>
                                </try>
                            </block>
                        </then>
                    </if>

                    <expr_stmt>
                        <expr>
                            <call>
                                <name>
                                    <name>logger</name>
                                    <operator>.</operator>
                                    <name>fine</name>
                                </name>
                                <argument_list>
                                    (
                                    <argument>
                                        <expr>
                                            <literal type="string">"Calling PortfolioClient.createPortfolio()"</literal>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>
                    <expr_stmt>
                        <expr>
                            <name>portfolio</name>
                            <operator>=</operator>
                            <call>
                                <name>
                                    <name>portfolioClient</name>
                                    <operator>.</operator>
                                    <name>createPortfolio</name>
                                </name>
                                <argument_list>
                                    (
                                    <argument>
                                        <expr>
                                            <name>jwt</name>
                                        </expr>
                                    </argument>
                                    ,
                                    <argument>
                                        <expr>
                                            <name>owner</name>
                                        </expr>
                                    </argument>
                                    ,
                                    <argument>
                                        <expr>
                                            <name>accountID</name>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>

                    <decl_stmt>
                        <decl>
                            <type>
                                <name>String</name>
                            </type>
                            <name>answer</name>
                            <init>
                                =
                                <expr>
                                    <literal type="string">"broker"</literal>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <if>
                        if
                        <condition>
                            (
                            <expr>
                                <name>portfolio</name>
                                <operator>!=</operator>
                                <literal type="null">null</literal>
                            </expr>
                            )
                        </condition>
                        <then>
                            <block>
                                {
                                <expr_stmt>
                                    <expr>
                                        <name>broker</name>
                                        <operator>=</operator>
                                        <operator>new</operator>
                                        <call>
                                            <name>Broker</name>
                                            <argument_list>
                                                (
                                                <argument>
                                                    <expr>
                                                        <name>portfolio</name>
                                                    </expr>
                                                </argument>
                                                ,
                                                <argument>
                                                    <expr>
                                                        <name>account</name>
                                                    </expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>
                                }
                            </block>
                        </then>
                        <else>
                            else
                            <block>
                                {
                                <expr_stmt>
                                    <expr>
                                        <name>answer</name>
                                        <operator>=</operator>
                                        <literal type="string">"null"</literal>
                                    </expr>
                                    ;
                                </expr_stmt>
                                }
                            </block>
                        </else>
                    </if>
                    <expr_stmt>
                        <expr>
                            <call>
                                <name>
                                    <name>logger</name>
                                    <operator>.</operator>
                                    <name>fine</name>
                                </name>
                                <argument_list>
                                    (
                                    <argument>
                                        <expr>
                                            <literal type="string">"Returning "</literal>
                                            <operator>+</operator>
                                            <name>answer</name>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>

                    <return>
                        return
                        <expr>
                            <name>broker</name>
                        </expr>
                        ;
                    </return>
                    }
                </block>
            </function>

            <function>
                <annotation>
                    @
                    <name>GET</name>
                </annotation>
                <annotation>
                    @
                    <name>Path</name>
                    <argument_list>
                        (
                        <argument>
                            <expr>
                                <literal type="string">"/{owner}"</literal>
                            </expr>
                        </argument>
                        )
                    </argument_list>
                </annotation>
                <annotation>
                    @
                    <name>Produces</name>
                    <argument_list>
                        (
                        <argument>
                            <expr>
                                <name>
                                    <name>MediaType</name>
                                    <operator>.</operator>
                                    <name>APPLICATION_JSON</name>
                                </name>
                            </expr>
                        </argument>
                        )
                    </argument_list>
                </annotation>
                <comment type="line">//	@RolesAllowed({"StockTrader", "StockViewer"}) //Couldn't get this to work; had to do it through the web.xml instead :(</comment>
                <specifier>public</specifier>
                <type>
                    <name>Broker</name>
                </type>
                <name>getBroker</name>
                <parameter_list>
                    (
                    <parameter>
                        <decl>
                            <type>
                                <annotation>
                                    @
                                    <name>PathParam</name>
                                    <argument_list>
                                        (
                                        <argument>
                                            <expr>
                                                <literal type="string">"owner"</literal>
                                            </expr>
                                        </argument>
                                        )
                                    </argument_list>
                                </annotation>
                                <name>String</name>
                            </type>
                            <name>owner</name>
                        </decl>
                    </parameter>
                    ,
                    <parameter>
                        <decl>
                            <type>
                                <annotation>
                                    @
                                    <name>Context</name>
                                </annotation>
                                <name>HttpServletRequest</name>
                            </type>
                            <name>request</name>
                        </decl>
                    </parameter>
                    )
                </parameter_list>
                <block>
                    {
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>Broker</name>
                            </type>
                            <name>broker</name>
                            <init>
                                =
                                <expr>
                                    <literal type="null">null</literal>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>Portfolio</name>
                            </type>
                            <name>portfolio</name>
                            <init>
                                =
                                <expr>
                                    <literal type="null">null</literal>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>String</name>
                            </type>
                            <name>jwt</name>
                            <init>
                                =
                                <expr>
                                    <call>
                                        <name>
                                            <name>request</name>
                                            <operator>.</operator>
                                            <name>getHeader</name>
                                        </name>
                                        <argument_list>
                                            (
                                            <argument>
                                                <expr>
                                                    <literal type="string">"Authorization"</literal>
                                                </expr>
                                            </argument>
                                            )
                                        </argument_list>
                                    </call>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>

                    <if>
                        if
                        <condition>
                            (
                            <expr>
                                <name>useCQRS</name>
                            </expr>
                            )
                        </condition>
                        <then>
                            <block>
                                {
                                <expr_stmt>
                                    <expr>
                                        <call>
                                            <name>
                                                <name>logger</name>
                                                <operator>.</operator>
                                                <name>info</name>
                                            </name>
                                            <argument_list>
                                                (
                                                <argument>
                                                    <expr>
                                                        <literal type="string">"getBroker: Placeholder for when CQRS support is added"</literal>
                                                    </expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>
                                }
                            </block>
                        </then>
                    </if>

                    <expr_stmt>
                        <expr>
                            <call>
                                <name>
                                    <name>logger</name>
                                    <operator>.</operator>
                                    <name>fine</name>
                                </name>
                                <argument_list>
                                    (
                                    <argument>
                                        <expr>
                                            <literal type="string">"Calling PortfolioClient.getPortfolio()"</literal>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>
                    <expr_stmt>
                        <expr>
                            <name>portfolio</name>
                            <operator>=</operator>
                            <call>
                                <name>
                                    <name>portfolioClient</name>
                                    <operator>.</operator>
                                    <name>getPortfolio</name>
                                </name>
                                <argument_list>
                                    (
                                    <argument>
                                        <expr>
                                            <name>jwt</name>
                                        </expr>
                                    </argument>
                                    ,
                                    <argument>
                                        <expr>
                                            <name>owner</name>
                                        </expr>
                                    </argument>
                                    ,
                                    <argument>
                                        <expr>
                                            <literal type="boolean">false</literal>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>

                    <decl_stmt>
                        <decl>
                            <type>
                                <name>String</name>
                            </type>
                            <name>answer</name>
                            <init>
                                =
                                <expr>
                                    <literal type="string">"broker"</literal>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <if>
                        if
                        <condition>
                            (
                            <expr>
                                <name>portfolio</name>
                                <operator>!=</operator>
                                <literal type="null">null</literal>
                            </expr>
                            )
                        </condition>
                        <then>
                            <block>
                                {
                                <decl_stmt>
                                    <decl>
                                        <type>
                                            <name>String</name>
                                        </type>
                                        <name>accountID</name>
                                        <init>
                                            =
                                            <expr>
                                                <call>
                                                    <name>
                                                        <name>portfolio</name>
                                                        <operator>.</operator>
                                                        <name>getAccountID</name>
                                                    </name>
                                                    <argument_list>()</argument_list>
                                                </call>
                                            </expr>
                                        </init>
                                    </decl>
                                    ;
                                </decl_stmt>
                                <decl_stmt>
                                    <decl>
                                        <type>
                                            <name>double</name>
                                        </type>
                                        <name>total</name>
                                        <init>
                                            =
                                            <expr>
                                                <call>
                                                    <name>
                                                        <name>portfolio</name>
                                                        <operator>.</operator>
                                                        <name>getTotal</name>
                                                    </name>
                                                    <argument_list>()</argument_list>
                                                </call>
                                            </expr>
                                        </init>
                                    </decl>
                                    ;
                                </decl_stmt>
                                <decl_stmt>
                                    <decl>
                                        <type>
                                            <name>Account</name>
                                        </type>
                                        <name>account</name>
                                        <init>
                                            =
                                            <expr>
                                                <literal type="null">null</literal>
                                            </expr>
                                        </init>
                                    </decl>
                                    ;
                                </decl_stmt>
                                <if>
                                    if
                                    <condition>
                                        (
                                        <expr>
                                            <name>useAccount</name>
                                        </expr>
                                        )
                                    </condition>
                                    <then>
                                        <block type="pseudo">
                                            <try>
                                                try
                                                <block>
                                                    {
                                                    <expr_stmt>
                                                        <expr>
                                                            <call>
                                                                <name>
                                                                    <name>logger</name>
                                                                    <operator>.</operator>
                                                                    <name>fine</name>
                                                                </name>
                                                                <argument_list>
                                                                    (
                                                                    <argument>
                                                                        <expr>
                                                                            <literal type="string">"Calling AccountClient.getAccount()"</literal>
                                                                        </expr>
                                                                    </argument>
                                                                    )
                                                                </argument_list>
                                                            </call>
                                                        </expr>
                                                        ;
                                                    </expr_stmt>
                                                    <expr_stmt>
                                                        <expr>
                                                            <name>account</name>
                                                            <operator>=</operator>
                                                            <call>
                                                                <name>
                                                                    <name>accountClient</name>
                                                                    <operator>.</operator>
                                                                    <name>getAccount</name>
                                                                </name>
                                                                <argument_list>
                                                                    (
                                                                    <argument>
                                                                        <expr>
                                                                            <name>jwt</name>
                                                                        </expr>
                                                                    </argument>
                                                                    ,
                                                                    <argument>
                                                                        <expr>
                                                                            <name>accountID</name>
                                                                        </expr>
                                                                    </argument>
                                                                    ,
                                                                    <argument>
                                                                        <expr>
                                                                            <name>total</name>
                                                                        </expr>
                                                                    </argument>
                                                                    )
                                                                </argument_list>
                                                            </call>
                                                        </expr>
                                                        ;
                                                    </expr_stmt>
                                                    <if>
                                                        if
                                                        <condition>
                                                            (
                                                            <expr>
                                                                <name>account</name>
                                                                <operator>==</operator>
                                                                <literal type="null">null</literal>
                                                            </expr>
                                                            )
                                                        </condition>
                                                        <then>
                                                            <block type="pseudo">
                                                                <expr_stmt>
                                                                    <expr>
                                                                        <call>
                                                                            <name>
                                                                                <name>logger</name>
                                                                                <operator>.</operator>
                                                                                <name>warning</name>
                                                                            </name>
                                                                            <argument_list>
                                                                                (
                                                                                <argument>
                                                                                    <expr>
                                                                                        <literal type="string">"Account not found for "</literal>
                                                                                        <operator>+</operator>
                                                                                        <name>owner</name>
                                                                                    </expr>
                                                                                </argument>
                                                                                )
                                                                            </argument_list>
                                                                        </call>
                                                                    </expr>
                                                                    ;
                                                                </expr_stmt>
                                                            </block>
                                                        </then>
                                                    </if>
                                                    }
                                                </block>
                                                <catch>
                                                    catch
                                                    <parameter_list>
                                                        (
                                                        <parameter>
                                                            <decl>
                                                                <type>
                                                                    <name>Throwable</name>
                                                                </type>
                                                                <name>t</name>
                                                            </decl>
                                                        </parameter>
                                                        )
                                                    </parameter_list>
                                                    <block>
                                                        {
                                                        <expr_stmt>
                                                            <expr>
                                                                <call>
                                                                    <name>logException</name>
                                                                    <argument_list>
                                                                        (
                                                                        <argument>
                                                                            <expr>
                                                                                <name>t</name>
                                                                            </expr>
                                                                        </argument>
                                                                        )
                                                                    </argument_list>
                                                                </call>
                                                            </expr>
                                                            ;
                                                        </expr_stmt>
                                                        }
                                                    </block>
                                                </catch>
                                            </try>
                                        </block>
                                    </then>
                                </if>
                                <expr_stmt>
                                    <expr>
                                        <name>broker</name>
                                        <operator>=</operator>
                                        <operator>new</operator>
                                        <call>
                                            <name>Broker</name>
                                            <argument_list>
                                                (
                                                <argument>
                                                    <expr>
                                                        <name>portfolio</name>
                                                    </expr>
                                                </argument>
                                                ,
                                                <argument>
                                                    <expr>
                                                        <name>account</name>
                                                    </expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>
                                }
                            </block>
                        </then>
                        <else>
                            else
                            <block>
                                {
                                <expr_stmt>
                                    <expr>
                                        <name>answer</name>
                                        <operator>=</operator>
                                        <literal type="string">"null"</literal>
                                    </expr>
                                    ;
                                </expr_stmt>
                                }
                            </block>
                        </else>
                    </if>
                    <expr_stmt>
                        <expr>
                            <call>
                                <name>
                                    <name>logger</name>
                                    <operator>.</operator>
                                    <name>fine</name>
                                </name>
                                <argument_list>
                                    (
                                    <argument>
                                        <expr>
                                            <literal type="string">"Returning "</literal>
                                            <operator>+</operator>
                                            <name>answer</name>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>

                    <return>
                        return
                        <expr>
                            <name>broker</name>
                        </expr>
                        ;
                    </return>
                    }
                </block>
            </function>

            <function>
                <annotation>
                    @
                    <name>GET</name>
                </annotation>
                <annotation>
                    @
                    <name>Path</name>
                    <argument_list>
                        (
                        <argument>
                            <expr>
                                <literal type="string">"/{owner}/returns"</literal>
                            </expr>
                        </argument>
                        )
                    </argument_list>
                </annotation>
                <annotation>
                    @
                    <name>Produces</name>
                    <argument_list>
                        (
                        <argument>
                            <expr>
                                <name>
                                    <name>MediaType</name>
                                    <operator>.</operator>
                                    <name>TEXT_PLAIN</name>
                                </name>
                            </expr>
                        </argument>
                        )
                    </argument_list>
                </annotation>
                <specifier>public</specifier>
                <type>
                    <name>String</name>
                </type>
                <name>getPortfolioReturns</name>
                <parameter_list>
                    (
                    <parameter>
                        <decl>
                            <type>
                                <annotation>
                                    @
                                    <name>PathParam</name>
                                    <argument_list>
                                        (
                                        <argument>
                                            <expr>
                                                <literal type="string">"owner"</literal>
                                            </expr>
                                        </argument>
                                        )
                                    </argument_list>
                                </annotation>
                                <name>String</name>
                            </type>
                            <name>owner</name>
                        </decl>
                    </parameter>
                    ,
                    <parameter>
                        <decl>
                            <type>
                                <annotation>
                                    @
                                    <name>Context</name>
                                </annotation>
                                <name>HttpServletRequest</name>
                            </type>
                            <name>request</name>
                        </decl>
                    </parameter>
                    )
                </parameter_list>
                <block>
                    {
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>String</name>
                            </type>
                            <name>jwt</name>
                            <init>
                                =
                                <expr>
                                    <call>
                                        <name>
                                            <name>request</name>
                                            <operator>.</operator>
                                            <name>getHeader</name>
                                        </name>
                                        <argument_list>
                                            (
                                            <argument>
                                                <expr>
                                                    <literal type="string">"Authorization"</literal>
                                                </expr>
                                            </argument>
                                            )
                                        </argument_list>
                                    </call>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>

                    <expr_stmt>
                        <expr>
                            <call>
                                <name>
                                    <name>logger</name>
                                    <operator>.</operator>
                                    <name>fine</name>
                                </name>
                                <argument_list>
                                    (
                                    <argument>
                                        <expr>
                                            <literal type="string">"Getting portfolio returns"</literal>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>String</name>
                            </type>
                            <name>result</name>
                            <init>
                                =
                                <expr>
                                    <literal type="string">"Unknown"</literal>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>Portfolio</name>
                            </type>
                            <name>portfolio</name>
                            <init>
                                =
                                <expr>
                                    <call>
                                        <name>
                                            <name>portfolioClient</name>
                                            <operator>.</operator>
                                            <name>getPortfolio</name>
                                        </name>
                                        <argument_list>
                                            (
                                            <argument>
                                                <expr>
                                                    <name>jwt</name>
                                                </expr>
                                            </argument>
                                            ,
                                            <argument>
                                                <expr>
                                                    <name>owner</name>
                                                </expr>
                                            </argument>
                                            ,
                                            <argument>
                                                <expr>
                                                    <literal type="boolean">true</literal>
                                                </expr>
                                            </argument>
                                            )
                                        </argument_list>
                                    </call>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <comment type="line">//throws a 404 exception if not present</comment>
                    <if>
                        if
                        <condition>
                            (
                            <expr>
                                <name>portfolio</name>
                                <operator>!=</operator>
                                <literal type="null">null</literal>
                            </expr>
                            )
                        </condition>
                        <then>
                            <block>
                                {
                                <decl_stmt>
                                    <decl>
                                        <type>
                                            <name>Double</name>
                                        </type>
                                        <name>portfolioValue</name>
                                        <init>
                                            =
                                            <expr>
                                                <call>
                                                    <name>
                                                        <name>portfolio</name>
                                                        <operator>.</operator>
                                                        <name>getTotal</name>
                                                    </name>
                                                    <argument_list>()</argument_list>
                                                </call>
                                            </expr>
                                        </init>
                                    </decl>
                                    ;
                                </decl_stmt>

                                <try>
                                    try
                                    <block>
                                        {
                                        <expr_stmt>
                                            <expr>
                                                <name>result</name>
                                                <operator>=</operator>
                                                <call>
                                                    <name>
                                                        <name>tradeHistoryClient</name>
                                                        <operator>.</operator>
                                                        <name>getReturns</name>
                                                    </name>
                                                    <argument_list>
                                                        (
                                                        <argument>
                                                            <expr>
                                                                <name>jwt</name>
                                                            </expr>
                                                        </argument>
                                                        ,
                                                        <argument>
                                                            <expr>
                                                                <name>owner</name>
                                                            </expr>
                                                        </argument>
                                                        ,
                                                        <argument>
                                                            <expr>
                                                                <name>portfolioValue</name>
                                                            </expr>
                                                        </argument>
                                                        )
                                                    </argument_list>
                                                </call>
                                            </expr>
                                            ;
                                        </expr_stmt>
                                        <expr_stmt>
                                            <expr>
                                                <call>
                                                    <name>
                                                        <name>logger</name>
                                                        <operator>.</operator>
                                                        <name>fine</name>
                                                    </name>
                                                    <argument_list>
                                                        (
                                                        <argument>
                                                            <expr>
                                                                <literal type="string">"Got portfolio returns for "</literal>
                                                                <operator>+</operator>
                                                                <name>owner</name>
                                                            </expr>
                                                        </argument>
                                                        )
                                                    </argument_list>
                                                </call>
                                            </expr>
                                            ;
                                        </expr_stmt>
                                        }
                                    </block>
                                    <catch>
                                        catch
                                        <parameter_list>
                                            (
                                            <parameter>
                                                <decl>
                                                    <type>
                                                        <name>Throwable</name>
                                                    </type>
                                                    <name>t</name>
                                                </decl>
                                            </parameter>
                                            )
                                        </parameter_list>
                                        <block>
                                            {
                                            <expr_stmt>
                                                <expr>
                                                    <call>
                                                        <name>
                                                            <name>logger</name>
                                                            <operator>.</operator>
                                                            <name>info</name>
                                                        </name>
                                                        <argument_list>
                                                            (
                                                            <argument>
                                                                <expr>
                                                                    <literal type="string">"Unable to invoke TradeHistory.  This is an optional microservice and the following exception is expected if it is not deployed"</literal>
                                                                </expr>
                                                            </argument>
                                                            )
                                                        </argument_list>
                                                    </call>
                                                </expr>
                                                ;
                                            </expr_stmt>
                                            <expr_stmt>
                                                <expr>
                                                    <call>
                                                        <name>logException</name>
                                                        <argument_list>
                                                            (
                                                            <argument>
                                                                <expr>
                                                                    <name>t</name>
                                                                </expr>
                                                            </argument>
                                                            )
                                                        </argument_list>
                                                    </call>
                                                </expr>
                                                ;
                                            </expr_stmt>
                                            }
                                        </block>
                                    </catch>
                                </try>
                                }
                            </block>
                        </then>
                        <else>
                            else
                            <block>
                                {
                                <expr_stmt>
                                    <expr>
                                        <call>
                                            <name>
                                                <name>logger</name>
                                                <operator>.</operator>
                                                <name>warning</name>
                                            </name>
                                            <argument_list>
                                                (
                                                <argument>
                                                    <expr>
                                                        <literal type="string">"Portfolio not found to get returns for "</literal>
                                                        <operator>+</operator>
                                                        <name>owner</name>
                                                    </expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>
                                }
                            </block>
                        </else>
                    </if>
                    <return>
                        return
                        <expr>
                            <name>result</name>
                        </expr>
                        ;
                    </return>
                    }
                </block>
            </function>

            <function>
                <annotation>
                    @
                    <name>PUT</name>
                </annotation>
                <annotation>
                    @
                    <name>Path</name>
                    <argument_list>
                        (
                        <argument>
                            <expr>
                                <literal type="string">"/{owner}"</literal>
                            </expr>
                        </argument>
                        )
                    </argument_list>
                </annotation>
                <annotation>
                    @
                    <name>Produces</name>
                    <argument_list>
                        (
                        <argument>
                            <expr>
                                <name>
                                    <name>MediaType</name>
                                    <operator>.</operator>
                                    <name>APPLICATION_JSON</name>
                                </name>
                            </expr>
                        </argument>
                        )
                    </argument_list>
                </annotation>
                <comment type="line">//	@RolesAllowed({"StockTrader"}) //Couldn't get this to work; had to do it through the web.xml instead :(</comment>
                <specifier>public</specifier>
                <type>
                    <name>Broker</name>
                </type>
                <name>updateBroker</name>
                <parameter_list>
                    (
                    <parameter>
                        <decl>
                            <type>
                                <annotation>
                                    @
                                    <name>PathParam</name>
                                    <argument_list>
                                        (
                                        <argument>
                                            <expr>
                                                <literal type="string">"owner"</literal>
                                            </expr>
                                        </argument>
                                        )
                                    </argument_list>
                                </annotation>
                                <name>String</name>
                            </type>
                            <name>owner</name>
                        </decl>
                    </parameter>
                    ,
                    <parameter>
                        <decl>
                            <type>
                                <annotation>
                                    @
                                    <name>QueryParam</name>
                                    <argument_list>
                                        (
                                        <argument>
                                            <expr>
                                                <literal type="string">"symbol"</literal>
                                            </expr>
                                        </argument>
                                        )
                                    </argument_list>
                                </annotation>
                                <name>String</name>
                            </type>
                            <name>symbol</name>
                        </decl>
                    </parameter>
                    ,
                    <parameter>
                        <decl>
                            <type>
                                <annotation>
                                    @
                                    <name>QueryParam</name>
                                    <argument_list>
                                        (
                                        <argument>
                                            <expr>
                                                <literal type="string">"shares"</literal>
                                            </expr>
                                        </argument>
                                        )
                                    </argument_list>
                                </annotation>
                                <name>int</name>
                            </type>
                            <name>shares</name>
                        </decl>
                    </parameter>
                    ,
                    <parameter>
                        <decl>
                            <type>
                                <annotation>
                                    @
                                    <name>Context</name>
                                </annotation>
                                <name>HttpServletRequest</name>
                            </type>
                            <name>request</name>
                        </decl>
                    </parameter>
                    )
                </parameter_list>
                <block>
                    {
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>Broker</name>
                            </type>
                            <name>broker</name>
                            <init>
                                =
                                <expr>
                                    <literal type="null">null</literal>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>Account</name>
                            </type>
                            <name>account</name>
                            <init>
                                =
                                <expr>
                                    <literal type="null">null</literal>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>Portfolio</name>
                            </type>
                            <name>portfolio</name>
                            <init>
                                =
                                <expr>
                                    <literal type="null">null</literal>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>String</name>
                            </type>
                            <name>jwt</name>
                            <init>
                                =
                                <expr>
                                    <call>
                                        <name>
                                            <name>request</name>
                                            <operator>.</operator>
                                            <name>getHeader</name>
                                        </name>
                                        <argument_list>
                                            (
                                            <argument>
                                                <expr>
                                                    <literal type="string">"Authorization"</literal>
                                                </expr>
                                            </argument>
                                            )
                                        </argument_list>
                                    </call>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>

                    <decl_stmt>
                        <decl>
                            <type>
                                <name>double</name>
                            </type>
                            <name>commission</name>
                            <init>
                                =
                                <expr>
                                    <literal type="number">0.0</literal>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>String</name>
                            </type>
                            <name>accountID</name>
                            <init>
                                =
                                <expr>
                                    <literal type="null">null</literal>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <if>
                        if
                        <condition>
                            (
                            <expr>
                                <name>useAccount</name>
                            </expr>
                            )
                        </condition>
                        <then>
                            <block type="pseudo">
                                <try>
                                    try
                                    <block>
                                        {
                                        <expr_stmt>
                                            <expr>
                                                <call>
                                                    <name>
                                                        <name>logger</name>
                                                        <operator>.</operator>
                                                        <name>fine</name>
                                                    </name>
                                                    <argument_list>
                                                        (
                                                        <argument>
                                                            <expr>
                                                                <literal type="string">"Calling PortfolioClient.getPortfolio() to get accountID in updateBroker()"</literal>
                                                            </expr>
                                                        </argument>
                                                        )
                                                    </argument_list>
                                                </call>
                                            </expr>
                                            ;
                                        </expr_stmt>
                                        <expr_stmt>
                                            <expr>
                                                <name>portfolio</name>
                                                <operator>=</operator>
                                                <call>
                                                    <name>
                                                        <name>portfolioClient</name>
                                                        <operator>.</operator>
                                                        <name>getPortfolio</name>
                                                    </name>
                                                    <argument_list>
                                                        (
                                                        <argument>
                                                            <expr>
                                                                <name>jwt</name>
                                                            </expr>
                                                        </argument>
                                                        ,
                                                        <argument>
                                                            <expr>
                                                                <name>owner</name>
                                                            </expr>
                                                        </argument>
                                                        ,
                                                        <argument>
                                                            <expr>
                                                                <literal type="boolean">false</literal>
                                                            </expr>
                                                        </argument>
                                                        )
                                                    </argument_list>
                                                </call>
                                            </expr>
                                            ;
                                        </expr_stmt>
                                        <comment type="line">//throws a 404 if it doesn't exist</comment>
                                        <expr_stmt>
                                            <expr>
                                                <name>accountID</name>
                                                <operator>=</operator>
                                                <call>
                                                    <name>
                                                        <name>portfolio</name>
                                                        <operator>.</operator>
                                                        <name>getAccountID</name>
                                                    </name>
                                                    <argument_list>()</argument_list>
                                                </call>
                                            </expr>
                                            ;
                                        </expr_stmt>

                                        <expr_stmt>
                                            <expr>
                                                <call>
                                                    <name>
                                                        <name>logger</name>
                                                        <operator>.</operator>
                                                        <name>fine</name>
                                                    </name>
                                                    <argument_list>
                                                        (
                                                        <argument>
                                                            <expr>
                                                                <literal type="string">"Calling AccountClient.getAccount() to get commission in updateBroker()"</literal>
                                                            </expr>
                                                        </argument>
                                                        )
                                                    </argument_list>
                                                </call>
                                            </expr>
                                            ;
                                        </expr_stmt>
                                        <expr_stmt>
                                            <expr>
                                                <name>account</name>
                                                <operator>=</operator>
                                                <call>
                                                    <name>
                                                        <name>accountClient</name>
                                                        <operator>.</operator>
                                                        <name>getAccount</name>
                                                    </name>
                                                    <argument_list>
                                                        (
                                                        <argument>
                                                            <expr>
                                                                <name>jwt</name>
                                                            </expr>
                                                        </argument>
                                                        ,
                                                        <argument>
                                                            <expr>
                                                                <name>accountID</name>
                                                            </expr>
                                                        </argument>
                                                        ,
                                                        <argument>
                                                            <expr>
                                                                <name>DONT_RECALCULATE</name>
                                                            </expr>
                                                        </argument>
                                                        )
                                                    </argument_list>
                                                </call>
                                            </expr>
                                            ;
                                        </expr_stmt>
                                        <expr_stmt>
                                            <expr>
                                                <name>commission</name>
                                                <operator>=</operator>
                                                <call>
                                                    <name>
                                                        <name>account</name>
                                                        <operator>.</operator>
                                                        <name>getNextCommission</name>
                                                    </name>
                                                    <argument_list>()</argument_list>
                                                </call>
                                            </expr>
                                            ;
                                        </expr_stmt>
                                        }
                                    </block>
                                    <catch>
                                        catch
                                        <parameter_list>
                                            (
                                            <parameter>
                                                <decl>
                                                    <type>
                                                        <name>Throwable</name>
                                                    </type>
                                                    <name>t</name>
                                                </decl>
                                            </parameter>
                                            )
                                        </parameter_list>
                                        <block>
                                            {
                                            <expr_stmt>
                                                <expr>
                                                    <call>
                                                        <name>logException</name>
                                                        <argument_list>
                                                            (
                                                            <argument>
                                                                <expr>
                                                                    <name>t</name>
                                                                </expr>
                                                            </argument>
                                                            )
                                                        </argument_list>
                                                    </call>
                                                </expr>
                                                ;
                                            </expr_stmt>
                                            }
                                        </block>
                                    </catch>
                                </try>
                            </block>
                        </then>
                    </if>

                    <expr_stmt>
                        <expr>
                            <call>
                                <name>
                                    <name>logger</name>
                                    <operator>.</operator>
                                    <name>fine</name>
                                </name>
                                <argument_list>
                                    (
                                    <argument>
                                        <expr>
                                            <literal type="string">"Calling PortfolioClient.updatePortfolio()"</literal>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>
                    <expr_stmt>
                        <expr>
                            <name>portfolio</name>
                            <operator>=</operator>
                            <call>
                                <name>
                                    <name>portfolioClient</name>
                                    <operator>.</operator>
                                    <name>updatePortfolio</name>
                                </name>
                                <argument_list>
                                    (
                                    <argument>
                                        <expr>
                                            <name>jwt</name>
                                        </expr>
                                    </argument>
                                    ,
                                    <argument>
                                        <expr>
                                            <name>owner</name>
                                        </expr>
                                    </argument>
                                    ,
                                    <argument>
                                        <expr>
                                            <name>symbol</name>
                                        </expr>
                                    </argument>
                                    ,
                                    <argument>
                                        <expr>
                                            <name>shares</name>
                                        </expr>
                                    </argument>
                                    ,
                                    <argument>
                                        <expr>
                                            <name>commission</name>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>

                    <decl_stmt>
                        <decl>
                            <type>
                                <name>String</name>
                            </type>
                            <name>answer</name>
                            <init>
                                =
                                <expr>
                                    <literal type="string">"broker"</literal>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <if>
                        if
                        <condition>
                            (
                            <expr>
                                <name>portfolio</name>
                                <operator>!=</operator>
                                <literal type="null">null</literal>
                            </expr>
                            )
                        </condition>
                        <then>
                            <block>
                                {
                                <decl_stmt>
                                    <decl>
                                        <type>
                                            <name>double</name>
                                        </type>
                                        <name>total</name>
                                        <init>
                                            =
                                            <expr>
                                                <call>
                                                    <name>
                                                        <name>portfolio</name>
                                                        <operator>.</operator>
                                                        <name>getTotal</name>
                                                    </name>
                                                    <argument_list>()</argument_list>
                                                </call>
                                            </expr>
                                        </init>
                                    </decl>
                                    ;
                                </decl_stmt>
                                <expr_stmt>
                                    <expr>
                                        <name>account</name>
                                        <operator>=</operator>
                                        <literal type="null">null</literal>
                                    </expr>
                                    ;
                                </expr_stmt>
                                <if>
                                    if
                                    <condition>
                                        (
                                        <expr>
                                            <name>useAccount</name>
                                        </expr>
                                        )
                                    </condition>
                                    <then>
                                        <block type="pseudo">
                                            <try>
                                                try
                                                <block>
                                                    {
                                                    <expr_stmt>
                                                        <expr>
                                                            <call>
                                                                <name>
                                                                    <name>logger</name>
                                                                    <operator>.</operator>
                                                                    <name>fine</name>
                                                                </name>
                                                                <argument_list>
                                                                    (
                                                                    <argument>
                                                                        <expr>
                                                                            <literal type="string">"Calling AccountClient.updateAccount()"</literal>
                                                                        </expr>
                                                                    </argument>
                                                                    )
                                                                </argument_list>
                                                            </call>
                                                        </expr>
                                                        ;
                                                    </expr_stmt>
                                                    <expr_stmt>
                                                        <expr>
                                                            <name>account</name>
                                                            <operator>=</operator>
                                                            <call>
                                                                <name>
                                                                    <name>accountClient</name>
                                                                    <operator>.</operator>
                                                                    <name>updateAccount</name>
                                                                </name>
                                                                <argument_list>
                                                                    (
                                                                    <argument>
                                                                        <expr>
                                                                            <name>jwt</name>
                                                                        </expr>
                                                                    </argument>
                                                                    ,
                                                                    <argument>
                                                                        <expr>
                                                                            <name>accountID</name>
                                                                        </expr>
                                                                    </argument>
                                                                    ,
                                                                    <argument>
                                                                        <expr>
                                                                            <name>total</name>
                                                                        </expr>
                                                                    </argument>
                                                                    )
                                                                </argument_list>
                                                            </call>
                                                        </expr>
                                                        ;
                                                    </expr_stmt>
                                                    }
                                                </block>
                                                <catch>
                                                    catch
                                                    <parameter_list>
                                                        (
                                                        <parameter>
                                                            <decl>
                                                                <type>
                                                                    <name>Throwable</name>
                                                                </type>
                                                                <name>t</name>
                                                            </decl>
                                                        </parameter>
                                                        )
                                                    </parameter_list>
                                                    <block>
                                                        {
                                                        <expr_stmt>
                                                            <expr>
                                                                <call>
                                                                    <name>logException</name>
                                                                    <argument_list>
                                                                        (
                                                                        <argument>
                                                                            <expr>
                                                                                <name>t</name>
                                                                            </expr>
                                                                        </argument>
                                                                        )
                                                                    </argument_list>
                                                                </call>
                                                            </expr>
                                                            ;
                                                        </expr_stmt>
                                                        }
                                                    </block>
                                                </catch>
                                            </try>
                                        </block>
                                    </then>
                                </if>
                                <expr_stmt>
                                    <expr>
                                        <name>broker</name>
                                        <operator>=</operator>
                                        <operator>new</operator>
                                        <call>
                                            <name>Broker</name>
                                            <argument_list>
                                                (
                                                <argument>
                                                    <expr>
                                                        <name>portfolio</name>
                                                    </expr>
                                                </argument>
                                                ,
                                                <argument>
                                                    <expr>
                                                        <name>account</name>
                                                    </expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>
                                }
                            </block>
                        </then>
                        <else>
                            else
                            <block>
                                {
                                <expr_stmt>
                                    <expr>
                                        <name>answer</name>
                                        <operator>=</operator>
                                        <literal type="string">"null"</literal>
                                    </expr>
                                    ;
                                </expr_stmt>
                                }
                            </block>
                        </else>
                    </if>
                    <expr_stmt>
                        <expr>
                            <call>
                                <name>
                                    <name>logger</name>
                                    <operator>.</operator>
                                    <name>fine</name>
                                </name>
                                <argument_list>
                                    (
                                    <argument>
                                        <expr>
                                            <literal type="string">"Returning "</literal>
                                            <operator>+</operator>
                                            <name>answer</name>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>

                    <return>
                        return
                        <expr>
                            <name>broker</name>
                        </expr>
                        ;
                    </return>
                    }
                </block>
            </function>

            <function>
                <annotation>
                    @
                    <name>DELETE</name>
                </annotation>
                <annotation>
                    @
                    <name>Path</name>
                    <argument_list>
                        (
                        <argument>
                            <expr>
                                <literal type="string">"/{owner}"</literal>
                            </expr>
                        </argument>
                        )
                    </argument_list>
                </annotation>
                <annotation>
                    @
                    <name>Produces</name>
                    <argument_list>
                        (
                        <argument>
                            <expr>
                                <name>
                                    <name>MediaType</name>
                                    <operator>.</operator>
                                    <name>APPLICATION_JSON</name>
                                </name>
                            </expr>
                        </argument>
                        )
                    </argument_list>
                </annotation>
                <comment type="line">//	@RolesAllowed({"StockTrader"}) //Couldn't get this to work; had to do it through the web.xml instead :(</comment>
                <specifier>public</specifier>
                <type>
                    <name>Broker</name>
                </type>
                <name>deleteBroker</name>
                <parameter_list>
                    (
                    <parameter>
                        <decl>
                            <type>
                                <annotation>
                                    @
                                    <name>PathParam</name>
                                    <argument_list>
                                        (
                                        <argument>
                                            <expr>
                                                <literal type="string">"owner"</literal>
                                            </expr>
                                        </argument>
                                        )
                                    </argument_list>
                                </annotation>
                                <name>String</name>
                            </type>
                            <name>owner</name>
                        </decl>
                    </parameter>
                    ,
                    <parameter>
                        <decl>
                            <type>
                                <annotation>
                                    @
                                    <name>Context</name>
                                </annotation>
                                <name>HttpServletRequest</name>
                            </type>
                            <name>request</name>
                        </decl>
                    </parameter>
                    )
                </parameter_list>
                <block>
                    {
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>Broker</name>
                            </type>
                            <name>broker</name>
                            <init>
                                =
                                <expr>
                                    <literal type="null">null</literal>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>Portfolio</name>
                            </type>
                            <name>portfolio</name>
                            <init>
                                =
                                <expr>
                                    <literal type="null">null</literal>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>String</name>
                            </type>
                            <name>jwt</name>
                            <init>
                                =
                                <expr>
                                    <call>
                                        <name>
                                            <name>request</name>
                                            <operator>.</operator>
                                            <name>getHeader</name>
                                        </name>
                                        <argument_list>
                                            (
                                            <argument>
                                                <expr>
                                                    <literal type="string">"Authorization"</literal>
                                                </expr>
                                            </argument>
                                            )
                                        </argument_list>
                                    </call>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>

                    <expr_stmt>
                        <expr>
                            <call>
                                <name>
                                    <name>logger</name>
                                    <operator>.</operator>
                                    <name>fine</name>
                                </name>
                                <argument_list>
                                    (
                                    <argument>
                                        <expr>
                                            <literal type="string">"Calling PortfolioClient.deletePortfolio()"</literal>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>
                    <expr_stmt>
                        <expr>
                            <name>portfolio</name>
                            <operator>=</operator>
                            <call>
                                <name>
                                    <name>portfolioClient</name>
                                    <operator>.</operator>
                                    <name>deletePortfolio</name>
                                </name>
                                <argument_list>
                                    (
                                    <argument>
                                        <expr>
                                            <name>jwt</name>
                                        </expr>
                                    </argument>
                                    ,
                                    <argument>
                                        <expr>
                                            <name>owner</name>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>

                    <decl_stmt>
                        <decl>
                            <type>
                                <name>String</name>
                            </type>
                            <name>answer</name>
                            <init>
                                =
                                <expr>
                                    <literal type="string">"broker"</literal>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <if>
                        if
                        <condition>
                            (
                            <expr>
                                <name>portfolio</name>
                                <operator>!=</operator>
                                <literal type="null">null</literal>
                            </expr>
                            )
                        </condition>
                        <then>
                            <block>
                                {
                                <decl_stmt>
                                    <decl>
                                        <type>
                                            <name>Account</name>
                                        </type>
                                        <name>account</name>
                                        <init>
                                            =
                                            <expr>
                                                <literal type="null">null</literal>
                                            </expr>
                                        </init>
                                    </decl>
                                    ;
                                </decl_stmt>
                                <if>
                                    if
                                    <condition>
                                        (
                                        <expr>
                                            <name>useAccount</name>
                                        </expr>
                                        )
                                    </condition>
                                    <then>
                                        <block type="pseudo">
                                            <try>
                                                try
                                                <block>
                                                    {
                                                    <decl_stmt>
                                                        <decl>
                                                            <type>
                                                                <name>String</name>
                                                            </type>
                                                            <name>accountID</name>
                                                            <init>
                                                                =
                                                                <expr>
                                                                    <call>
                                                                        <name>
                                                                            <name>portfolio</name>
                                                                            <operator>.</operator>
                                                                            <name>getAccountID</name>
                                                                        </name>
                                                                        <argument_list>()</argument_list>
                                                                    </call>
                                                                </expr>
                                                            </init>
                                                        </decl>
                                                        ;
                                                    </decl_stmt>
                                                    <expr_stmt>
                                                        <expr>
                                                            <call>
                                                                <name>
                                                                    <name>logger</name>
                                                                    <operator>.</operator>
                                                                    <name>fine</name>
                                                                </name>
                                                                <argument_list>
                                                                    (
                                                                    <argument>
                                                                        <expr>
                                                                            <literal type="string">"Calling AccountClient.deleteAccount()"</literal>
                                                                        </expr>
                                                                    </argument>
                                                                    )
                                                                </argument_list>
                                                            </call>
                                                        </expr>
                                                        ;
                                                    </expr_stmt>
                                                    <expr_stmt>
                                                        <expr>
                                                            <name>account</name>
                                                            <operator>=</operator>
                                                            <call>
                                                                <name>
                                                                    <name>accountClient</name>
                                                                    <operator>.</operator>
                                                                    <name>deleteAccount</name>
                                                                </name>
                                                                <argument_list>
                                                                    (
                                                                    <argument>
                                                                        <expr>
                                                                            <name>jwt</name>
                                                                        </expr>
                                                                    </argument>
                                                                    ,
                                                                    <argument>
                                                                        <expr>
                                                                            <name>accountID</name>
                                                                        </expr>
                                                                    </argument>
                                                                    )
                                                                </argument_list>
                                                            </call>
                                                        </expr>
                                                        ;
                                                    </expr_stmt>
                                                    }
                                                </block>
                                                <catch>
                                                    catch
                                                    <parameter_list>
                                                        (
                                                        <parameter>
                                                            <decl>
                                                                <type>
                                                                    <name>Throwable</name>
                                                                </type>
                                                                <name>t</name>
                                                            </decl>
                                                        </parameter>
                                                        )
                                                    </parameter_list>
                                                    <block>
                                                        {
                                                        <expr_stmt>
                                                            <expr>
                                                                <call>
                                                                    <name>logException</name>
                                                                    <argument_list>
                                                                        (
                                                                        <argument>
                                                                            <expr>
                                                                                <name>t</name>
                                                                            </expr>
                                                                        </argument>
                                                                        )
                                                                    </argument_list>
                                                                </call>
                                                            </expr>
                                                            ;
                                                        </expr_stmt>
                                                        }
                                                    </block>
                                                </catch>
                                            </try>
                                        </block>
                                    </then>
                                </if>
                                <expr_stmt>
                                    <expr>
                                        <name>broker</name>
                                        <operator>=</operator>
                                        <operator>new</operator>
                                        <call>
                                            <name>Broker</name>
                                            <argument_list>
                                                (
                                                <argument>
                                                    <expr>
                                                        <name>portfolio</name>
                                                    </expr>
                                                </argument>
                                                ,
                                                <argument>
                                                    <expr>
                                                        <name>account</name>
                                                    </expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>
                                }
                            </block>
                        </then>
                        <else>
                            else
                            <block>
                                {
                                <expr_stmt>
                                    <expr>
                                        <name>answer</name>
                                        <operator>=</operator>
                                        <literal type="string">"null"</literal>
                                    </expr>
                                    ;
                                </expr_stmt>
                                }
                            </block>
                        </else>
                    </if>
                    <expr_stmt>
                        <expr>
                            <call>
                                <name>
                                    <name>logger</name>
                                    <operator>.</operator>
                                    <name>fine</name>
                                </name>
                                <argument_list>
                                    (
                                    <argument>
                                        <expr>
                                            <literal type="string">"Returning "</literal>
                                            <operator>+</operator>
                                            <name>answer</name>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>

                    <return>
                        return
                        <expr>
                            <name>broker</name>
                        </expr>
                        ;
                    </return>
                    <comment type="line">//maybe this method should return void instead?</comment>
                    }
                </block>
            </function>

            <function>
                <annotation>
                    @
                    <name>POST</name>
                </annotation>
                <annotation>
                    @
                    <name>Path</name>
                    <argument_list>
                        (
                        <argument>
                            <expr>
                                <literal type="string">"/{owner}/feedback"</literal>
                            </expr>
                        </argument>
                        )
                    </argument_list>
                </annotation>
                <annotation>
                    @
                    <name>Consumes</name>
                    <argument_list>
                        (
                        <argument>
                            <expr>
                                <name>
                                    <name>MediaType</name>
                                    <operator>.</operator>
                                    <name>APPLICATION_JSON</name>
                                </name>
                            </expr>
                        </argument>
                        )
                    </argument_list>
                </annotation>
                <annotation>
                    @
                    <name>Produces</name>
                    <argument_list>
                        (
                        <argument>
                            <expr>
                                <name>
                                    <name>MediaType</name>
                                    <operator>.</operator>
                                    <name>APPLICATION_JSON</name>
                                </name>
                            </expr>
                        </argument>
                        )
                    </argument_list>
                </annotation>
                <comment type="line">//	@RolesAllowed({"StockTrader"}) //Couldn't get this to work; had to do it through the web.xml instead :(</comment>
                <specifier>public</specifier>
                <type>
                    <name>Feedback</name>
                </type>
                <name>submitFeedback</name>
                <parameter_list>
                    (
                    <parameter>
                        <decl>
                            <type>
                                <annotation>
                                    @
                                    <name>PathParam</name>
                                    <argument_list>
                                        (
                                        <argument>
                                            <expr>
                                                <literal type="string">"owner"</literal>
                                            </expr>
                                        </argument>
                                        )
                                    </argument_list>
                                </annotation>
                                <name>String</name>
                            </type>
                            <name>owner</name>
                        </decl>
                    </parameter>
                    ,
                    <parameter>
                        <decl>
                            <type>
                                <name>WatsonInput</name>
                            </type>
                            <name>input</name>
                        </decl>
                    </parameter>
                    ,
                    <parameter>
                        <decl>
                            <type>
                                <annotation>
                                    @
                                    <name>Context</name>
                                </annotation>
                                <name>HttpServletRequest</name>
                            </type>
                            <name>request</name>
                        </decl>
                    </parameter>
                    )
                </parameter_list>
                <block>
                    {
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>Feedback</name>
                            </type>
                            <name>feedback</name>
                            <init>
                                =
                                <expr>
                                    <literal type="null">null</literal>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>String</name>
                            </type>
                            <name>jwt</name>
                            <init>
                                =
                                <expr>
                                    <call>
                                        <name>
                                            <name>request</name>
                                            <operator>.</operator>
                                            <name>getHeader</name>
                                        </name>
                                        <argument_list>
                                            (
                                            <argument>
                                                <expr>
                                                    <literal type="string">"Authorization"</literal>
                                                </expr>
                                            </argument>
                                            )
                                        </argument_list>
                                    </call>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>

                    <expr_stmt>
                        <expr>
                            <call>
                                <name>
                                    <name>logger</name>
                                    <operator>.</operator>
                                    <name>fine</name>
                                </name>
                                <argument_list>
                                    (
                                    <argument>
                                        <expr>
                                            <literal type="string">"Calling AccountClient.submitFeedback()"</literal>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>
                    <expr_stmt>
                        <expr>
                            <name>feedback</name>
                            <operator>=</operator>
                            <call>
                                <name>
                                    <name>accountClient</name>
                                    <operator>.</operator>
                                    <name>submitFeedback</name>
                                </name>
                                <argument_list>
                                    (
                                    <argument>
                                        <expr>
                                            <name>jwt</name>
                                        </expr>
                                    </argument>
                                    ,
                                    <argument>
                                        <expr>
                                            <name>owner</name>
                                        </expr>
                                    </argument>
                                    ,
                                    <argument>
                                        <expr>
                                            <name>input</name>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>

                    <decl_stmt>
                        <decl>
                            <type>
                                <name>String</name>
                            </type>
                            <name>answer</name>
                            <init>
                                =
                                <expr>
                                    <literal type="string">"feedback"</literal>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <if>
                        if
                        <condition>
                            (
                            <expr>
                                <name>feedback</name>
                                <operator>==</operator>
                                <literal type="null">null</literal>
                            </expr>
                            )
                        </condition>
                        <then>
                            <block type="pseudo">
                                <expr_stmt>
                                    <expr>
                                        <name>answer</name>
                                        <operator>=</operator>
                                        <literal type="string">"null"</literal>
                                    </expr>
                                    ;
                                </expr_stmt>
                            </block>
                        </then>
                    </if>
                    <expr_stmt>
                        <expr>
                            <call>
                                <name>
                                    <name>logger</name>
                                    <operator>.</operator>
                                    <name>fine</name>
                                </name>
                                <argument_list>
                                    (
                                    <argument>
                                        <expr>
                                            <literal type="string">"Returning "</literal>
                                            <operator>+</operator>
                                            <name>answer</name>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>

                    <return>
                        return
                        <expr>
                            <name>feedback</name>
                        </expr>
                        ;
                    </return>
                    }
                </block>
            </function>

            <function>
                <specifier>static</specifier>
                <type>
                    <name>void</name>
                </type>
                <name>logException</name>
                <parameter_list>
                    (
                    <parameter>
                        <decl>
                            <type>
                                <name>Throwable</name>
                            </type>
                            <name>t</name>
                        </decl>
                    </parameter>
                    )
                </parameter_list>
                <block>
                    {
                    <expr_stmt>
                        <expr>
                            <call>
                                <name>
                                    <name>logger</name>
                                    <operator>.</operator>
                                    <name>warning</name>
                                </name>
                                <argument_list>
                                    (
                                    <argument>
                                        <expr>
                                            <call>
                                                <name>
                                                    <name>t</name>
                                                    <operator>.</operator>
                                                    <name>getClass</name>
                                                </name>
                                                <argument_list>()</argument_list>
                                            </call>
                                            <operator>.</operator>
                                            <call>
                                                <name>getName</name>
                                                <argument_list>()</argument_list>
                                            </call>
                                            <operator>+</operator>
                                            <literal type="string">": "</literal>
                                            <operator>+</operator>
                                            <call>
                                                <name>
                                                    <name>t</name>
                                                    <operator>.</operator>
                                                    <name>getMessage</name>
                                                </name>
                                                <argument_list>()</argument_list>
                                            </call>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>

                    <comment type="line">//only log the stack trace if the level has been set to at least INFO</comment>
                    <if>
                        if
                        <condition>
                            (
                            <expr>
                                <call>
                                    <name>
                                        <name>logger</name>
                                        <operator>.</operator>
                                        <name>isLoggable</name>
                                    </name>
                                    <argument_list>
                                        (
                                        <argument>
                                            <expr>
                                                <name>
                                                    <name>Level</name>
                                                    <operator>.</operator>
                                                    <name>INFO</name>
                                                </name>
                                            </expr>
                                        </argument>
                                        )
                                    </argument_list>
                                </call>
                            </expr>
                            )
                        </condition>
                        <then>
                            <block>
                                {
                                <decl_stmt>
                                    <decl>
                                        <type>
                                            <name>StringWriter</name>
                                        </type>
                                        <name>writer</name>
                                        <init>
                                            =
                                            <expr>
                                                <operator>new</operator>
                                                <call>
                                                    <name>StringWriter</name>
                                                    <argument_list>()</argument_list>
                                                </call>
                                            </expr>
                                        </init>
                                    </decl>
                                    ;
                                </decl_stmt>
                                <expr_stmt>
                                    <expr>
                                        <call>
                                            <name>
                                                <name>t</name>
                                                <operator>.</operator>
                                                <name>printStackTrace</name>
                                            </name>
                                            <argument_list>
                                                (
                                                <argument>
                                                    <expr>
                                                        <operator>new</operator>
                                                        <call>
                                                            <name>PrintWriter</name>
                                                            <argument_list>
                                                                (
                                                                <argument>
                                                                    <expr>
                                                                        <name>writer</name>
                                                                    </expr>
                                                                </argument>
                                                                )
                                                            </argument_list>
                                                        </call>
                                                    </expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>
                                <expr_stmt>
                                    <expr>
                                        <call>
                                            <name>
                                                <name>logger</name>
                                                <operator>.</operator>
                                                <name>info</name>
                                            </name>
                                            <argument_list>
                                                (
                                                <argument>
                                                    <expr>
                                                        <call>
                                                            <name>
                                                                <name>writer</name>
                                                                <operator>.</operator>
                                                                <name>toString</name>
                                                            </name>
                                                            <argument_list>()</argument_list>
                                                        </call>
                                                    </expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>
                                }
                            </block>
                        </then>
                    </if>
                    }
                </block>
            </function>
            }
        </block>
    </class>
</unit>
